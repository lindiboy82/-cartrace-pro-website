<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CarTrace Pro - Enhanced Dashboard</title>
    
    <!-- Stripe.js -->
    <script src="https://js.stripe.com/v3/"></script>
    
    <!-- Leaflet for Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --secondary: #2196F3;
            --danger: #ef4444;
            --warning: #f59e0b;
            --success: #10b981;
            --info: #3b82f6;
            --dark: #111827;
            --light: #f8fafc;
            --white: #FFFFFF;
            --surface: #f3f4f6;
            --card-bg: rgba(255, 255, 255, 0.95);
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --nav-selected: rgba(79, 70, 229, 0.1);
            --carfax-blue: #0057B8;
            --carfax-orange: #FF6B35;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text-primary);
        }

        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Navigation */
        .sidebar {
            width: 280px;
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        .logo-section {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
        }

        .app-logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 15px;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 400"><defs><radialGradient id="globeGrad" cx="50%" cy="40%" r="70%"><stop offset="0%" style="stop-color:%23a8c8ec"/><stop offset="100%" style="stop-color:%232563eb"/></radialGradient></defs><circle cx="200" cy="220" r="140" fill="url(%23globeGrad)"/><g stroke="white" stroke-width="3" fill="none"><circle cx="200" cy="220" r="140"/><ellipse cx="200" cy="220" rx="140" ry="70"/><ellipse cx="200" cy="220" rx="70" ry="140"/><line x1="60" y1="220" x2="340" y2="220"/><line x1="200" y1="80" x2="200" y2="360"/></g><path d="M200 80 L230 160 L200 200 Z" fill="%23dc2626"/><ellipse cx="210" cy="130" rx="18" ry="18" fill="white"/><text x="200" y="35" text-anchor="middle" fill="%23111827" font-family="Arial Black" font-size="40" font-weight="bold">Car Trace</text></svg>') center/contain no-repeat;
        }

        .app-title {
            font-size: 20px;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .app-subtitle {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .sync-status {
            font-size: 12px;
            color: var(--success);
            margin-top: 10px;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 8px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            color: var(--text-primary);
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s;
            font-weight: 500;
            cursor: pointer;
        }

        .nav-link:hover, .nav-link.active {
            background: var(--primary);
            color: white;
            transform: translateX(4px);
        }

        .nav-icon {
            margin-right: 12px;
            font-size: 18px;
        }

        /* Notification Badge */
        .notification-badge {
            background: var(--danger);
            color: white;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: auto;
            animation: pulse 2s infinite;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .header {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            padding: 20px 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 28px;
            font-weight: bold;
            color: var(--primary);
        }

        .header-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Content Sections */
        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        /* Cards */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
        }

        .card-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .card-icon {
            margin-right: 10px;
            font-size: 24px;
        }

        /* Vehicle List */
        .vehicle-list {
            display: grid;
            gap: 20px;
        }

        .vehicle-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            border-left: 4px solid var(--primary);
            position: relative;
        }

        .vehicle-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .vehicle-info h3 {
            color: var(--primary);
            margin-bottom: 5px;
        }

        .vehicle-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 13px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-edit {
            background: var(--info);
            color: white;
        }

        .btn-edit:hover {
            background: #2563eb;
        }

        .btn-delete {
            background: var(--danger);
            color: white;
        }

        .btn-delete:hover {
            background: #dc2626;
        }

        .vehicle-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 50px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
        }

        .close-modal {
            font-size: 28px;
            cursor: pointer;
            color: var(--text-secondary);
            background: none;
            border: none;
        }

        .close-modal:hover {
            color: var(--danger);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            font-size: 16px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        /* Map Container */
        #map {
            height: 600px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .alert-popup {
            padding: 10px;
        }

        .alert-popup h4 {
            color: var(--danger);
            margin-bottom: 8px;
        }

        .alert-popup p {
            margin: 4px 0;
            font-size: 13px;
        }

        .alert-popup .btn-small {
            margin-top: 10px;
            width: 100%;
        }

        /* Alert Card */
        .alert-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid var(--danger);
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .alert-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .alert-time {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .alert-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-active {
            background: #fee2e2;
            color: var(--danger);
        }

        .status-recovered {
            background: #d1fae5;
            color: var(--success);
        }

        /* Notification Toast */
        .notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            max-width: 400px;
            z-index: 2000;
            border-left: 4px solid var(--danger);
            animation: slideIn 0.3s ease-out;
            display: none;
        }

        .notification-toast.show {
            display: block;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .notification-title {
            font-weight: bold;
            color: var(--danger);
            font-size: 16px;
        }

        .notification-body {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .notification-actions {
            display: flex;
            gap: 10px;
        }

        /* Insurance Portal Styles */
        .insurance-portal {
            max-width: 1200px;
            margin: 0 auto;
        }

        .portal-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        .portal-tab {
            padding: 12px 24px;
            background: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .portal-tab.active {
            background: var(--primary);
            color: white;
        }

        .insurance-login-form {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .insurance-dashboard {
            display: none;
        }

        .insurance-dashboard.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-label {
            color: var(--text-secondary);
            margin-top: 5px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
            }
            
            .nav-link span {
                display: none;
            }
            
            .logo-section .app-title,
            .logo-section .app-subtitle {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo-section">
                <div class="app-logo"></div>
                <div class="app-title">CarTrace Pro</div>
                <div class="app-subtitle">Vehicle Protection Network</div>
                <div class="sync-status" id="sync-status">⏳ Syncing...</div>
            </div>
            
            <ul class="nav-menu">
                <li class="nav-item">
                    <a class="nav-link active" onclick="showSection('dashboard')">
                        <span class="nav-icon">🏠</span>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showSection('vehicles')">
                        <span class="nav-icon">🚗</span>
                        <span>My Vehicles</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showSection('map-alerts')">
                        <span class="nav-icon">🗺️</span>
                        <span>Map & Alerts</span>
                        <span class="notification-badge" id="alert-badge">0</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showSection('protection')">
                        <span class="nav-icon">🛡️</span>
                        <span>Protection Plans</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showSection('found-vehicle')">
                        <span class="nav-icon">🔍</span>
                        <span>Found Vehicle</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showSection('insurance')">
                        <span class="nav-icon">🏢</span>
                        <span>Insurance Portal</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showSection('carfax')">
                        <span class="nav-icon">📋</span>
                        <span>Carfax Integration</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showSection('analytics')">
                        <span class="nav-icon">📊</span>
                        <span>Analytics</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showSection('settings')">
                        <span class="nav-icon">⚙️</span>
                        <span>Settings</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="signOut()">
                        <span class="nav-icon">🚪</span>
                        <span>Sign Out</span>
                    </a>
                </li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Section -->
            <div class="content-section active" id="dashboard-section">
                <div class="header">
                    <div>
                        <h1 class="header-title">Welcome Back!</h1>
                        <p id="user-email">Loading...</p>
                    </div>
                    <div class="header-status">
                        <span class="status-dot"></span>
                        <span>Network Active</span>
                    </div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-title">
                            <span class="card-icon">🚗</span>
                            Protected Vehicles
                        </div>
                        <div style="font-size: 36px; font-weight: bold; color: var(--primary); margin: 15px 0;">
                            <span id="vehicle-count">0</span>
                        </div>
                        <div style="color: var(--text-secondary); font-size: 14px;">
                            Active protection plans
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title">
                            <span class="card-icon">🌐</span>
                            Network Status
                        </div>
                        <div style="font-size: 36px; font-weight: bold; color: var(--success); margin: 15px 0;">
                            <span id="active-users">47,892</span>
                        </div>
                        <div style="color: var(--text-secondary); font-size: 14px;">
                            Active community members
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title">
                            <span class="card-icon">🎯</span>
                            Response Time
                        </div>
                        <div style="font-size: 36px; font-weight: bold; color: var(--info); margin: 15px 0;">
                            <span id="response-time">0.8</span>ms
                        </div>
                        <div style="color: var(--text-secondary); font-size: 14px;">
                            Average alert delivery
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">
                        <span class="card-icon">🔔</span>
                        Recent Alerts
                    </div>
                    <div id="recent-alerts">
                        <p style="color: var(--text-secondary); text-align: center; padding: 20px;">
                            No recent alerts in your area. Your vehicles are safe! ✅
                        </p>
                    </div>
                </div>
            </div>

            <!-- My Vehicles Section -->
            <div class="content-section" id="vehicles-section">
                <div class="header">
                    <h1 class="header-title">My Vehicles</h1>
                    <button class="btn btn-primary" onclick="showAddVehicleModal()" style="width: auto;">
                        + Add Vehicle
                    </button>
                </div>

                <div class="vehicle-list" id="vehicle-list">
                    <p style="text-align: center; color: var(--text-secondary); padding: 40px;">
                        No vehicles added yet. Click "Add Vehicle" to get started!
                    </p>
                </div>
            </div>

            <!-- Map & Alerts Section -->
            <div class="content-section" id="map-alerts-section">
                <div class="header">
                    <h1 class="header-title">Live Map & Stolen Vehicle Alerts</h1>
                    <div class="header-status">
                        <span class="status-dot"></span>
                        <span>Real-Time Tracking Active</span>
                    </div>
                </div>

                <div class="cards-grid" style="margin-bottom: 20px;">
                    <div class="card">
                        <div class="card-title">
                            <span class="card-icon">🚨</span>
                            Active Alerts
                        </div>
                        <div style="font-size: 36px; font-weight: bold; color: var(--danger); margin: 15px 0;">
                            <span id="active-alerts-count">0</span>
                        </div>
                        <div style="color: var(--text-secondary); font-size: 14px;">
                            Stolen vehicles in your area
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title">
                            <span class="card-icon">📍</span>
                            Your Location
                        </div>
                        <div style="font-size: 16px; font-weight: bold; color: var(--primary); margin: 15px 0;">
                            <span id="user-location">Detecting...</span>
                        </div>
                        <div style="color: var(--text-secondary); font-size: 14px;">
                            Current position
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title">
                            <span class="card-icon">✅</span>
                            Recoveries
                        </div>
                        <div style="font-size: 36px; font-weight: bold; color: var(--success); margin: 15px 0;">
                            1,247
                        </div>
                        <div style="color: var(--text-secondary); font-size: 14px;">
                            Total vehicles recovered
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-bottom: 20px;">
                    <div id="map"></div>
                </div>

                <div class="card">
                    <div class="card-title">
                        <span class="card-icon">📋</span>
                        Alert Details
                    </div>
                    <div id="alerts-list">
                        <p style="text-align: center; color: var(--text-secondary); padding: 20px;">
                            No active alerts at this time.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Protection Plans Section -->
            <div class="content-section" id="protection-section">
                <div class="header">
                    <h1 class="header-title">Protection Plans</h1>
                </div>

                <div class="cards-grid">
                    <div class="card" style="border: 2px solid var(--info);">
                        <div class="card-title">
                            <span class="card-icon">🥉</span>
                            Basic Protection
                        </div>
                        <div style="font-size: 32px; font-weight: bold; color: var(--primary); margin: 15px 0;">
                            $17.99<span style="font-size: 16px;">/mo</span>
                        </div>
                        <ul style="list-style: none; padding: 0; color: var(--text-secondary);">
                            <li style="padding: 8px 0;">✅ Community alerts</li>
                            <li style="padding: 8px 0;">✅ GPS tracking</li>
                            <li style="padding: 8px 0;">✅ $200 recovery reward</li>
                            <li style="padding: 8px 0;">✅ 24/7 support</li>
                        </ul>
                        <button class="btn btn-primary" onclick="startCheckout('basic')">Select Plan</button>
                    </div>

                    <div class="card" style="border: 2px solid var(--warning);">
                        <div class="card-title">
                            <span class="card-icon">🥈</span>
                            Gold Protection
                        </div>
                        <div style="font-size: 32px; font-weight: bold; color: var(--primary); margin: 15px 0;">
                            $24.99<span style="font-size: 16px;">/mo</span>
                        </div>
                        <ul style="list-style: none; padding: 0; color: var(--text-secondary);">
                            <li style="padding: 8px 0;">✅ All Basic features</li>
                            <li style="padding: 8px 0;">✅ Priority alerts</li>
                            <li style="padding: 8px 0;">✅ $300 recovery reward</li>
                            <li style="padding: 8px 0;">✅ Insurance integration</li>
                        </ul>
                        <button class="btn btn-primary" onclick="startCheckout('gold')">Select Plan</button>
                    </div>

                    <div class="card" style="border: 2px solid #c0c0c0;">
                        <div class="card-title">
                            <span class="card-icon">🥇</span>
                            Platinum Protection
                        </div>
                        <div style="font-size: 32px; font-weight: bold; color: var(--primary); margin: 15px 0;">
                            $29.99<span style="font-size: 16px;">/mo</span>
                        </div>
                        <ul style="list-style: none; padding: 0; color: var(--text-secondary);">
                            <li style="padding: 8px 0;">✅ All Gold features</li>
                            <li style="padding: 8px 0;">✅ Real-time tracking</li>
                            <li style="padding: 8px 0;">✅ $500 recovery reward</li>
                            <li style="padding: 8px 0;">✅ Carfax integration</li>
                        </ul>
                        <button class="btn btn-primary" onclick="startCheckout('platinum')">Select Plan</button>
                    </div>

                    <div class="card" style="border: 2px solid var(--primary);">
                        <div class="card-title">
                            <span class="card-icon">💎</span>
                            Diamond Protection
                        </div>
                        <div style="font-size: 32px; font-weight: bold; color: var(--primary); margin: 15px 0;">
                            $35.00<span style="font-size: 16px;">/mo</span>
                        </div>
                        <ul style="list-style: none; padding: 0; color: var(--text-secondary);">
                            <li style="padding: 8px 0;">✅ All Platinum features</li>
                            <li style="padding: 8px 0;">✅ Instant alerts</li>
                            <li style="padding: 8px 0;">✅ $750 recovery reward</li>
                            <li style="padding: 8px 0;">✅ Dedicated support</li>
                        </ul>
                        <button class="btn btn-primary" onclick="startCheckout('diamond')">Select Plan</button>
                    </div>
                </div>
            </div>

            <!-- Found Vehicle Section -->
            <div class="content-section" id="found-vehicle-section">
                <div class="header">
                    <h1 class="header-title">Report Found Stolen Vehicle</h1>
                </div>

                <div class="card">
                    <p style="margin-bottom: 20px; color: var(--text-secondary);">
                        Help recover stolen vehicles and earn rewards! If you've spotted a vehicle with an active theft alert, report it here.
                    </p>

                    <form id="found-vehicle-form">
                        <div class="form-group">
                            <label class="form-label">License Plate Number *</label>
                            <input type="text" class="form-input" id="found-plate" required placeholder="Enter plate number">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Current Location *</label>
                            <input type="text" class="form-input" id="found-location" required placeholder="Street address or landmark">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Police Report Number *</label>
                            <input type="text" class="form-input" id="found-report" required placeholder="Report #">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Police Department *</label>
                            <input type="text" class="form-input" id="found-department" required placeholder="Department name">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Your Name *</label>
                            <input type="text" class="form-input" id="found-witness" required placeholder="Full name">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Zelle Contact (for reward payment) *</label>
                            <input type="text" class="form-input" id="found-zelle" required placeholder="Email or phone">
                        </div>

                        <button type="submit" class="btn btn-primary">Submit Report</button>
                    </form>
                </div>
            </div>

            <!-- Insurance Portal Section -->
            <div class="content-section" id="insurance-section">
                <div class="header">
                    <h1 class="header-title">Insurance Company Portal</h1>
                </div>

                <div class="insurance-portal">
                    <div class="portal-tabs">
                        <button class="portal-tab active" onclick="showInsuranceTab('login')">Sign In</button>
                        <button class="portal-tab" onclick="showInsuranceTab('signup')">Register Company</button>
                    </div>

                    <!-- Login Form -->
                    <div id="insurance-login-tab" class="insurance-login-form">
                        <h2 style="text-align: center; margin-bottom: 30px; color: var(--primary);">
                            Insurance Company Login
                        </h2>
                        <form id="insurance-login-form">
                            <div class="form-group">
                                <label class="form-label">Company Email</label>
                                <input type="email" class="form-input" required placeholder="company@insurance.com">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Password</label>
                                <input type="password" class="form-input" required placeholder="Enter password">
                            </div>
                            <button type="submit" class="btn btn-primary">Sign In</button>
                        </form>
                    </div>

                    <!-- Signup Form -->
                    <div id="insurance-signup-tab" class="insurance-login-form" style="display: none;">
                        <h2 style="text-align: center; margin-bottom: 30px; color: var(--primary);">
                            Register Your Insurance Company
                        </h2>
                        <form id="insurance-signup-form">
                            <div class="form-group">
                                <label class="form-label">Company Name</label>
                                <input type="text" class="form-input" required placeholder="ABC Insurance Co.">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Company Email</label>
                                <input type="email" class="form-input" required placeholder="contact@insurance.com">
                            </div>
                            <div class="form-group">
                                <label class="form-label">License Number</label>
                                <input type="text" class="form-input" required placeholder="Insurance license #">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Phone Number</label>
                                <input type="tel" class="form-input" required placeholder="(555) 123-4567">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Password</label>
                                <input type="password" class="form-input" required placeholder="Create password">
                            </div>
                            <button type="submit" class="btn btn-primary">Register Company</button>
                        </form>
                    </div>

                    <!-- Insurance Dashboard (shown after login) -->
                    <div id="insurance-dashboard" class="insurance-dashboard">
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value">1,247</div>
                                <div class="stat-label">Vehicles Recovered</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">$2.1M</div>
                                <div class="stat-label">Claims Prevented</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">156</div>
                                <div class="stat-label">Active Policies</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">98.5%</div>
                                <div class="stat-label">Recovery Rate</div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-title">
                                <span class="card-icon">📋</span>
                                Recent Claims
                            </div>
                            <p style="color: var(--text-secondary); padding: 20px; text-align: center;">
                                No pending claims at this time.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Carfax Section -->
            <div class="content-section" id="carfax-section">
                <div class="header">
                    <h1 class="header-title">Carfax Integration</h1>
                </div>

                <div class="card">
                    <div class="card-title">
                        <span class="card-icon">📋</span>
                        Connect Your Carfax Account
                    </div>
                    <p style="margin-bottom: 20px; color: var(--text-secondary);">
                        Link your Carfax Car Care account for enhanced vehicle tracking and maintenance alerts.
                    </p>
                    <button class="btn btn-primary" onclick="connectCarfax()">Connect Carfax</button>
                </div>
            </div>

            <!-- Analytics Section -->
            <div class="content-section" id="analytics-section">
                <div class="header">
                    <h1 class="header-title">Network Analytics</h1>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-title">
                            <span class="card-icon">⏱️</span>
                            Network Uptime
                        </div>
                        <div style="font-size: 36px; font-weight: bold; color: var(--success); margin: 15px 0;">
                            <span id="network-uptime">99.95</span>%
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title">
                            <span class="card-icon">🔒</span>
                            Security Score
                        </div>
                        <div style="font-size: 36px; font-weight: bold; color: var(--success); margin: 15px 0;">
                            <span id="security-score">98</span>/100
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title">
                            <span class="card-icon">📊</span>
                            Data Points
                        </div>
                        <div style="font-size: 36px; font-weight: bold; color: var(--info); margin: 15px 0;">
                            <span id="data-points">1,234,567</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Section -->
            <div class="content-section" id="settings-section">
                <div class="header">
                    <h1 class="header-title">Account Settings</h1>
                </div>

                <div class="card">
                    <div class="card-title">
                        <span class="card-icon">👤</span>
                        Profile Information
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        <input type="email" class="form-input" id="settings-email" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Member Since</label>
                        <input type="text" class="form-input" id="member-since" readonly>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">
                        <span class="card-icon">🔔</span>
                        Notification Preferences
                    </div>
                    <div style="padding: 10px 0;">
                        <label style="display: flex; align-items: center; margin-bottom: 15px;">
                            <input type="checkbox" checked style="margin-right: 10px;">
                            <span>Email notifications for stolen vehicle alerts</span>
                        </label>
                        <label style="display: flex; align-items: center; margin-bottom: 15px;">
                            <input type="checkbox" checked style="margin-right: 10px;">
                            <span>Push notifications for nearby alerts</span>
                        </label>
                        <label style="display: flex; align-items: center;">
                            <input type="checkbox" checked style="margin-right: 10px;">
                            <span>Weekly network activity summaries</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Vehicle Modal -->
    <div class="modal" id="add-vehicle-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add New Vehicle</h2>
                <button class="close-modal" onclick="closeAddVehicleModal()">&times;</button>
            </div>
            <form id="add-vehicle-form">
                <div class="form-group">
                    <label class="form-label">Year *</label>
                    <input type="number" class="form-input" id="add-year" required min="1900" max="2025" placeholder="2020">
                </div>

                <div class="form-group">
                    <label class="form-label">Make *</label>
                    <input type="text" class="form-input" id="add-make" required placeholder="Toyota">
                </div>

                <div class="form-group">
                    <label class="form-label">Model *</label>
                    <input type="text" class="form-input" id="add-model" required placeholder="Camry">
                </div>

                <div class="form-group">
                    <label class="form-label">Color *</label>
                    <input type="text" class="form-input" id="add-color" required placeholder="Silver">
                </div>

                <div class="form-group">
                    <label class="form-label">License Plate *</label>
                    <input type="text" class="form-input" id="add-plate" required placeholder="ABC123">
                </div>

                <div class="form-group">
                    <label class="form-label">VIN (Optional)</label>
                    <input type="text" class="form-input" id="add-vin" maxlength="17" placeholder="17-digit VIN number">
                </div>

                <div class="form-group">
                    <label class="form-label">Protection Plan *</label>
                    <select class="form-select" id="add-plan" required>
                        <option value="basic">Basic - $17.99/mo</option>
                        <option value="gold">Gold - $24.99/mo</option>
                        <option value="platinum">Platinum - $29.99/mo</option>
                        <option value="diamond">Diamond - $35.00/mo</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-primary">Add Vehicle</button>
            </form>
        </div>
    </div>

    <!-- Edit Vehicle Modal -->
    <div class="modal" id="edit-vehicle-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Edit Vehicle</h2>
                <button class="close-modal" onclick="closeEditModal()">&times;</button>
            </div>
            <form id="edit-vehicle-form">
                <input type="hidden" id="edit-vehicle-id">
                
                <div class="form-group">
                    <label class="form-label">VIN (Optional)</label>
                    <input type="text" class="form-input" id="edit-vin" maxlength="17" placeholder="Enter 17-digit VIN">
                </div>

                <div class="form-group">
                    <label class="form-label">Protection Plan</label>
                    <select class="form-select" id="edit-plan" required>
                        <option value="basic">Basic - $17.99/mo</option>
                        <option value="gold">Gold - $24.99/mo</option>
                        <option value="platinum">Platinum - $29.99/mo</option>
                        <option value="diamond">Diamond - $35.00/mo</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">License Plate</label>
                    <input type="text" class="form-input" id="edit-plate" readonly>
                </div>

                <div class="form-group">
                    <label class="form-label">Vehicle</label>
                    <input type="text" class="form-input" id="edit-vehicle-display" readonly>
                </div>

                <button type="submit" class="btn btn-primary">Save Changes</button>
            </form>
        </div>
    </div>

    <!-- Notification Toast -->
    <div class="notification-toast" id="notification-toast">
        <div class="notification-header">
            <div class="notification-title">🚨 STOLEN VEHICLE ALERT</div>
            <button class="close-modal" onclick="closeNotification()" style="font-size: 20px;">&times;</button>
        </div>
        <div class="notification-body" id="notification-body">
            A vehicle has been reported stolen in your area!
        </div>
        <div class="notification-actions">
            <button class="btn-small btn-primary" onclick="viewAlertDetails()">View Details</button>
            <button class="btn-small btn-edit" onclick="closeNotification()">Dismiss</button>
        </div>
    </div>

    <script>
        // Initialize Stripe
        const stripe = Stripe('pk_test_51QeTZeRxPKUgpxLKOOPLpxDGJoCF3u7QmGqBjsVqRJZuEcAzQ1JW4iqh6XxGIONhL9o7JnqkdPcXzFYt8bPbvC6x009cz5i5rT');

        // Global variables
        let map = null;
        let userMarker = null;
        let alertMarkers = [];
        let stolenVehicles = [];
        let alertNotificationInterval = null;

        // Mock stolen vehicles data (in production, this comes from Firebase)
        const mockStolenVehicles = [
            {
                id: '1',
                plate: 'ABC123',
                make: 'Toyota',
                model: 'Camry',
                year: '2020',
                color: 'Silver',
                lat: 26.142,
                lng: -81.795,
                reportedAt: Date.now() - 3600000,
                status: 'active',
                reward: 500
            },
            {
                id: '2',
                plate: 'XYZ789',
                make: 'Honda',
                model: 'Civic',
                year: '2019',
                color: 'Blue',
                lat: 26.650,
                lng: -81.872,
                reportedAt: Date.now() - 7200000,
                status: 'active',
                reward: 300
            }
        ];

        // Navigation
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionId + '-section').classList.add('active');
            
            // Add active class to clicked nav link
            event.target.closest('.nav-link').classList.add('active');

            // Initialize map if showing map section
            if (sectionId === 'map-alerts' && !map) {
                setTimeout(initializeMap, 100);
            }
        }

        // Initialize Map
        function initializeMap() {
            if (map) return;

            // Default to Naples, FL
            const defaultLat = 26.1420;
            const defaultLng = -81.7948;

            map = L.map('map').setView([defaultLat, defaultLng], 12);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            // Try to get user's actual location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        map.setView([lat, lng], 13);
                        
                        // Add user marker
                        userMarker = L.marker([lat, lng], {
                            icon: L.divIcon({
                                className: 'user-marker',
                                html: '<div style="background: #4f46e5; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.3);"></div>',
                                iconSize: [20, 20]
                            })
                        }).addTo(map).bindPopup('Your Location');

                        // Update location display
                        document.getElementById('user-location').textContent = 
                            `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                    },
                    error => {
                        console.log('Location access denied, using default location');
                        document.getElementById('user-location').textContent = 'Naples, FL';
                    }
                );
            }

            // Add stolen vehicle markers
            loadStolenVehicleMarkers();
        }

        // Load stolen vehicle markers on map
        function loadStolenVehicleMarkers() {
            stolenVehicles = mockStolenVehicles;
            
            stolenVehicles.forEach(vehicle => {
                const marker = L.marker([vehicle.lat, vehicle.lng], {
                    icon: L.divIcon({
                        className: 'alert-marker',
                        html: '<div style="background: #ef4444; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">!</div>',
                        iconSize: [30, 30]
                    })
                }).addTo(map);

                const timeSince = Math.floor((Date.now() - vehicle.reportedAt) / 60000);
                marker.bindPopup(`
                    <div class="alert-popup">
                        <h4>🚨 ${vehicle.year} ${vehicle.make} ${vehicle.model}</h4>
                        <p><strong>Plate:</strong> ${vehicle.plate}</p>
                        <p><strong>Color:</strong> ${vehicle.color}</p>
                        <p><strong>Reported:</strong> ${timeSince} minutes ago</p>
                        <p><strong>Reward:</strong> $${vehicle.reward}</p>
                        <button class="btn-small btn-primary" onclick="reportSighting('${vehicle.id}')">
                            Report Sighting
                        </button>
                    </div>
                `);

                alertMarkers.push(marker);
            });

            updateAlertCounts();
            displayAlertsList();
        }

        // Update alert counts
        function updateAlertCounts() {
            const count = stolenVehicles.length;
            document.getElementById('active-alerts-count').textContent = count;
            document.getElementById('alert-badge').textContent = count;
            
            if (count > 0) {
                document.getElementById('alert-badge').style.display = 'block';
            }
        }

        // Display alerts list
        function displayAlertsList() {
            const alertsList = document.getElementById('alerts-list');
            
            if (stolenVehicles.length === 0) {
                alertsList.innerHTML = `
                    <p style="text-align: center; color: var(--text-secondary); padding: 20px;">
                        No active alerts at this time.
                    </p>
                `;
                return;
            }

            alertsList.innerHTML = stolenVehicles.map(vehicle => {
                const timeSince = Math.floor((Date.now() - vehicle.reportedAt) / 60000);
                return `
                    <div class="alert-card">
                        <div class="alert-header">
                            <div>
                                <h3 style="color: var(--danger); margin-bottom: 5px;">
                                    ${vehicle.year} ${vehicle.make} ${vehicle.model}
                                </h3>
                                <p class="alert-time">${timeSince} minutes ago</p>
                            </div>
                            <span class="alert-status status-active">ACTIVE</span>
                        </div>
                        <div class="vehicle-details">
                            <div class="detail-item">
                                <span class="detail-label">License Plate</span>
                                <span>${vehicle.plate}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Color</span>
                                <span>${vehicle.color}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Reward</span>
                                <span style="color: var(--success); font-weight: bold;">$${vehicle.reward}</span>
                            </div>
                        </div>
                        <button class="btn-small btn-primary" style="margin-top: 10px; width: auto;" onclick="reportSighting('${vehicle.id}')">
                            Report Sighting
                        </button>
                    </div>
                `;
            }).join('');

            // Also update recent alerts on dashboard
            const recentAlerts = document.getElementById('recent-alerts');
            recentAlerts.innerHTML = alertsList.innerHTML;
        }

        // Report vehicle sighting
        function reportSighting(vehicleId) {
            alert('Thank you! Your sighting report has been submitted. If verified, you\'ll receive the reward payment via Zelle within 2-5 business days.');
        }

        // Show real-time notification
        function showNotification(vehicle) {
            const toast = document.getElementById('notification-toast');
            const body = document.getElementById('notification-body');
            
            body.textContent = `A ${vehicle.year} ${vehicle.make} ${vehicle.model} (${vehicle.plate}) was just reported stolen near your location! Reward: $${vehicle.reward}`;
            
            toast.classList.add('show');
            
            // Auto-hide after 10 seconds
            setTimeout(() => {
                closeNotification();
            }, 10000);
        }

        function closeNotification() {
            document.getElementById('notification-toast').classList.remove('show');
        }

        function viewAlertDetails() {
            closeNotification();
            showSection('map-alerts');
        }

        // Simulate real-time alerts (in production, use Firebase real-time listeners)
        function startAlertMonitoring() {
            // Show a test notification after 5 seconds
            setTimeout(() => {
                if (mockStolenVehicles.length > 0) {
                    showNotification(mockStolenVehicles[0]);
                }
            }, 5000);
        }

        // Vehicle Management
        function updateVehicleDisplay() {
            const vehicleList = document.getElementById('vehicle-list');
            
            if (!window.userVehicles || window.userVehicles.length === 0) {
                vehicleList.innerHTML = `
                    <p style="text-align: center; color: var(--text-secondary); padding: 40px;">
                        No vehicles added yet. Click "Add Vehicle" to get started!
                    </p>
                `;
                return;
            }

            vehicleList.innerHTML = window.userVehicles.map(vehicle => `
                <div class="vehicle-card">
                    <div class="vehicle-header">
                        <div class="vehicle-info">
                            <h3>${vehicle.year} ${vehicle.make} ${vehicle.model}</h3>
                            <p style="color: var(--text-secondary);">${vehicle.color}</p>
                        </div>
                        <div class="vehicle-actions">
                            <button class="btn-small btn-edit" onclick="openEditModal('${vehicle.id}')">
                                ✏️ Edit
                            </button>
                            <button class="btn-small btn-delete" onclick="deleteVehicle('${vehicle.id}')">
                                🗑️ Delete
                            </button>
                        </div>
                    </div>
                    <div class="vehicle-details">
                        <div class="detail-item">
                            <span class="detail-label">License Plate</span>
                            <span>${vehicle.licensePlate}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">VIN</span>
                            <span>${vehicle.vin || 'Not provided'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Protection Plan</span>
                            <span style="color: var(--primary); font-weight: bold; text-transform: capitalize;">
                                ${vehicle.plan || 'Basic'}
                            </span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Status</span>
                            <span style="color: var(--success); font-weight: bold;">
                                ✅ Protected
                            </span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateVehicleCount() {
            const count = window.userVehicles ? window.userVehicles.length : 0;
            document.getElementById('vehicle-count').textContent = count;
        }

        // Edit Vehicle Modal
        function openEditModal(vehicleId) {
            const vehicle = window.userVehicles.find(v => v.id === vehicleId);
            if (!vehicle) return;

            document.getElementById('edit-vehicle-id').value = vehicle.id;
            document.getElementById('edit-vin').value = vehicle.vin || '';
            document.getElementById('edit-plan').value = vehicle.plan || 'basic';
            document.getElementById('edit-plate').value = vehicle.licensePlate;
            document.getElementById('edit-vehicle-display').value = 
                `${vehicle.year} ${vehicle.make} ${vehicle.model} - ${vehicle.color}`;

            document.getElementById('edit-vehicle-modal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('edit-vehicle-modal').classList.remove('active');
        }

        // Handle edit form submission
        document.getElementById('edit-vehicle-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const vehicleId = document.getElementById('edit-vehicle-id').value;
            const vin = document.getElementById('edit-vin').value.trim();
            const plan = document.getElementById('edit-plan').value;

            if (!window.currentUser) {
                alert('Please log in to edit vehicles');
                return;
            }

            try {
                // Update in Firebase
                const vehicleRef = window.firebaseRef(
                    window.firebaseDatabase, 
                    `vehicles/${window.currentUser.uid}/${vehicleId}`
                );
                
                await window.firebaseUpdate(vehicleRef, {
                    vin: vin,
                    plan: plan,
                    updatedAt: Date.now()
                });

                alert('✅ Vehicle updated successfully!');
                closeEditModal();
                
                // The onValue listener will automatically update the display
            } catch (error) {
                console.error('Error updating vehicle:', error);
                alert('❌ Error updating vehicle. Please try again.');
            }
        });

        // Delete Vehicle
        async function deleteVehicle(vehicleId) {
            if (!confirm('Are you sure you want to delete this vehicle? This cannot be undone.')) {
                return;
            }

            if (!window.currentUser) {
                alert('Please log in to delete vehicles');
                return;
            }

            try {
                const vehicleRef = window.firebaseRef(
                    window.firebaseDatabase, 
                    `vehicles/${window.currentUser.uid}/${vehicleId}`
                );
                
                await window.firebaseRemove(vehicleRef);
                
                alert('✅ Vehicle deleted successfully!');
            } catch (error) {
                console.error('Error deleting vehicle:', error);
                alert('❌ Error deleting vehicle. Please try again.');
            }
        }

        // Add Vehicle Modal Functions
        function showAddVehicleModal() {
            document.getElementById('add-vehicle-modal').classList.add('active');
        }

        function closeAddVehicleModal() {
            document.getElementById('add-vehicle-modal').classList.remove('active');
            document.getElementById('add-vehicle-form').reset();
        }

        // Handle Add Vehicle Form Submission
        document.getElementById('add-vehicle-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!window.currentUser) {
                alert('Please log in to add vehicles');
                return;
            }

            const year = document.getElementById('add-year').value.trim();
            const make = document.getElementById('add-make').value.trim();
            const model = document.getElementById('add-model').value.trim();
            const color = document.getElementById('add-color').value.trim();
            const licensePlate = document.getElementById('add-plate').value.trim().toUpperCase();
            const vin = document.getElementById('add-vin').value.trim();
            const plan = document.getElementById('add-plan').value;

            try {
                // Create new vehicle in Firebase
                const vehiclesRef = window.firebaseRef(
                    window.firebaseDatabase, 
                    `vehicles/${window.currentUser.uid}`
                );
                
                const newVehicleRef = window.firebasePush(vehiclesRef);
                
                await window.firebaseSet(newVehicleRef, {
                    id: newVehicleRef.key,
                    year: year,
                    make: make,
                    model: model,
                    color: color,
                    licensePlate: licensePlate,
                    vin: vin,
                    plan: plan,
                    stolen: false,
                    createdAt: Date.now(),
                    updatedAt: Date.now()
                });

                alert('✅ Vehicle added successfully!');
                closeAddVehicleModal();
                
                // The onValue listener will automatically update the display
                
            } catch (error) {
                console.error('Error adding vehicle:', error);
                alert('❌ Error adding vehicle. Please try again.');
            }
        });

        // Insurance Portal
        function showInsuranceTab(tab) {
            document.querySelectorAll('.portal-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            if (tab === 'login') {
                document.getElementById('insurance-login-tab').style.display = 'block';
                document.getElementById('insurance-signup-tab').style.display = 'none';
            } else {
                document.getElementById('insurance-login-tab').style.display = 'none';
                document.getElementById('insurance-signup-tab').style.display = 'block';
            }
        }

        // Insurance login
        document.getElementById('insurance-login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            alert('✅ Insurance company login successful! Redirecting to dashboard...');
            document.getElementById('insurance-login-tab').style.display = 'none';
            document.getElementById('insurance-signup-tab').style.display = 'none';
            document.getElementById('insurance-dashboard').classList.add('active');
        });

        // Insurance signup
        document.getElementById('insurance-signup-form').addEventListener('submit', (e) => {
            e.preventDefault();
            alert('✅ Insurance company registration submitted! Our team will review and contact you within 24-48 hours.');
        });

        // Found Vehicle Form
        document.getElementById('found-vehicle-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const plate = document.getElementById('found-plate').value.trim();
            const location = document.getElementById('found-location').value.trim();
            const report = document.getElementById('found-report').value.trim();
            const department = document.getElementById('found-department').value.trim();
            const witness = document.getElementById('found-witness').value.trim();
            const zelle = document.getElementById('found-zelle').value.trim();

            const reportId = 'FR-' + Date.now();

            alert(
                `✅ FOUND VEHICLE REPORT SUBMITTED!\n\n` +
                `📋 Report ID: ${reportId}\n` +
                `🏷️ License Plate: ${plate.toUpperCase()}\n` +
                `📍 Location: ${location}\n` +
                `🔢 Police Report: ${report}\n` +
                `👮 Department: ${department}\n` +
                `👤 Witness: ${witness}\n` +
                `💰 Zelle Contact: ${zelle}\n\n` +
                `⏳ VERIFICATION PROCESS:\n\n` +
                `1️⃣ Our team will verify with ${department}\n` +
                `2️⃣ We'll confirm report #${report}\n` +
                `3️⃣ Match with vehicle owner's theft report\n` +
                `4️⃣ Process reward payment via Zelle\n\n` +
                `⏰ Verification typically takes 2-5 business days\n` +
                `💵 Reward amount: Based on vehicle's protection plan\n` +
                `   • Basic: $200\n` +
                `   • Gold: $300\n` +
                `   • Platinum: $500\n` +
                `   • Diamond: $750\n\n` +
                `📧 You'll receive email updates\n\n` +
                `🙏 Thank you for helping our community!\n\n` +
                `Your report ID: ${reportId}\n` +
                `Save this number for reference.`
            );

            e.target.reset();
        });

        // Stripe Checkout
        async function startCheckout(plan) {
            const priceIds = {
                basic: 'price_1QeTcRRxPKUgpxLKFsjv4iZC',
                gold: 'price_1QeTcnRxPKUgpxLKRvvfzC3Q',
                platinum: 'price_1QeTd4RxPKUgpxLKJKZyaG0O',
                diamond: 'price_1QeTdFRxPKUgpxLKU1oXUa9w'
            };

            try {
                const response = await fetch('https://YOUR_BACKEND_URL/create-checkout-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        priceId: priceIds[plan],
                        userId: window.currentUser ? window.currentUser.uid : null,
                        userEmail: window.currentUser ? window.currentUser.email : null
                    })
                });

                const session = await response.json();
                
                const result = await stripe.redirectToCheckout({
                    sessionId: session.id
                });

                if (result.error) {
                    alert(result.error.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Unable to start checkout. Please try again.');
            }
        }

        // Carfax Connection
        function connectCarfax() {
            alert('🚧 Carfax integration coming soon! You\'ll be able to link your Carfax Car Care account for enhanced vehicle tracking.');
        }

        // Sign Out
        function signOut() {
            if (confirm('Are you sure you want to sign out?')) {
                if (window.firebaseSignOut && window.firebaseAuth) {
                    window.firebaseSignOut(window.firebaseAuth).then(() => {
                        localStorage.clear();
                        sessionStorage.clear();
                        window.location.href = 'cartrace_homepage.html';
                    }).catch((error) => {
                        console.error('Logout error:', error);
                        window.location.href = 'cartrace_homepage.html';
                    });
                } else {
                    window.location.href = 'cartrace_homepage.html';
                }
            }
        }

        // Live Stats Updates
        let networkUptime = 99.95;
        let responseTime = 0.8;
        let securityScore = 98;
        let dataPoints = 1234567;
        let activeUsers = 47892;

        function updateLiveStats() {
            const random = Math.random();
            
            if (random < 0.4) {
                networkUptime = Math.max(99.90, Math.min(99.99, networkUptime + (Math.random() - 0.5) * 0.02));
                responseTime = Math.max(0.5, Math.min(1.2, responseTime + (Math.random() - 0.5) * 0.1));
                securityScore = Math.max(90, Math.min(100, securityScore + Math.floor((Math.random() - 0.5) * 3)));
                dataPoints += Math.floor(Math.random() * 10);
                activeUsers = 47892 + Math.floor(Math.random() * 100);
            }
            
            document.getElementById('network-uptime').textContent = networkUptime.toFixed(2);
            document.getElementById('response-time').textContent = responseTime.toFixed(1);
            document.getElementById('security-score').textContent = securityScore;
            document.getElementById('data-points').textContent = dataPoints.toLocaleString();
            document.getElementById('active-users').textContent = activeUsers.toLocaleString();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Start real-time updates
            setInterval(updateLiveStats, 3000);
            
            // Start alert monitoring
            startAlertMonitoring();
            
            // Update sync status
            setTimeout(() => {
                document.getElementById('sync-status').textContent = '✅ Community network connected';
                document.getElementById('sync-status').style.color = 'var(--success)';
            }, 2000);
        });
    </script>

    <!-- Firebase Module Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        import { getDatabase, ref, set, get, push, remove, update, onValue, off } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB8iFriCB3kt4lWeXQUNj5LTsAXFZoXX0Y",
            authDomain: "cartrace-pro.firebaseapp.com",
            databaseURL: "https://cartrace-pro-default-rtdb.firebaseio.com/",
            projectId: "cartrace-pro",
            storageBucket: "cartrace-pro.firebasestorage.app",
            messagingSenderId: "341907523496",
            appId: "1:341907523496:web:f10a87930d939cf3b8ff9d",
            measurementId: "G-X01QW112CD"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        window.firebaseAuth = auth;
        window.firebaseDatabase = database;
        window.firebaseRef = ref;
        window.firebaseSet = set;
        window.firebaseGet = get;
        window.firebasePush = push;
        window.firebaseRemove = remove;
        window.firebaseUpdate = update;
        window.firebaseOnValue = onValue;
        window.firebaseOff = off;
        window.firebaseSignOut = signOut;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                window.currentUser = user;
                
                document.getElementById('user-email').textContent = user.email || 'User';
                document.getElementById('settings-email').value = user.email || 'user@example.com';
                document.getElementById('member-since').value = new Date(user.metadata.creationTime).toLocaleDateString();
                
                // Load vehicles with real-time updates
                const vehiclesRef = ref(database, `vehicles/${user.uid}`);
                onValue(vehiclesRef, (snapshot) => {
                    const data = snapshot.val();
                    
                    if (data) {
                        window.userVehicles = Object.keys(data).map(key => ({
                            ...data[key],
                            id: data[key].id || key
                        }));
                        localStorage.setItem('cartraceVehicles', JSON.stringify(window.userVehicles));
                    } else {
                        window.userVehicles = [];
                        localStorage.setItem('cartraceVehicles', JSON.stringify([]));
                    }
                    
                    updateVehicleDisplay();
                    updateVehicleCount();
                });

                // Listen for stolen vehicle alerts in real-time
                const alertsRef = ref(database, 'stolenVehicles');
                onValue(alertsRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        const alerts = Object.keys(data).map(key => ({
                            ...data[key],
                            id: key
                        }));
                        
                        // Check for new alerts
                        alerts.forEach(alert => {
                            if (!stolenVehicles.find(v => v.id === alert.id)) {
                                showNotification(alert);
                            }
                        });
                        
                        stolenVehicles = alerts;
                        if (map) {
                            // Update map markers
                            alertMarkers.forEach(marker => map.removeLayer(marker));
                            alertMarkers = [];
                            loadStolenVehicleMarkers();
                        }
                        updateAlertCounts();
                        displayAlertsList();
                    }
                });
            } else {
                window.location.href = 'cartrace_homepage.html';
            }
        });
    </script>
</body>
</html>

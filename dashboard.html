<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"="width=device-width, initial-scale=1.0">
    <title>CarTrace Pro - Complete Enhanced Dashboard</title>
    
    <!-- Stripe.js -->
    <script src="https://js.stripe.com/v3/"></script>
    
    <!-- Leaflet for Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --secondary: #2196F3;
            --danger: #ef4444;
            --warning: #f59e0b;
            --success: #10b981;
            --info: #3b82f6;
            --dark: #111827;
            --light: #f8fafc;
            --white: #FFFFFF;
            --surface: #f3f4f6;
            --card-bg: rgba(255, 255, 255, 0.95);
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --nav-selected: rgba(79, 70, 229, 0.1);
            --carfax-blue: #0057B8;
            --carfax-orange: #FF6B35;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text-primary);
        }

        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Navigation */
        .sidebar {
            width: 280px;
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .logo-section {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
        }

        .app-logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 15px;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 400"><defs><radialGradient id="globeGrad" cx="50%" cy="40%" r="70%"><stop offset="0%" style="stop-color:%23a8c8ec"/><stop offset="100%" style="stop-color:%232563eb"/></radialGradient></defs><circle cx="200" cy="220" r="140" fill="url(%23globeGrad)"/><g stroke="white" stroke-width="3" fill="none"><circle cx="200" cy="220" r="140"/><ellipse cx="200" cy="220" rx="140" ry="70"/><ellipse cx="200" cy="220" rx="70" ry="140"/><line x1="60" y1="220" x2="340" y2="220"/><line x1="200" y1="80" x2="200" y2="360"/></g><path d="M200 80 L230 160 L200 200 Z" fill="%23dc2626"/><ellipse cx="210" cy="130" rx="18" ry="18" fill="white"/><text x="200" y="35" text-anchor="middle" fill="%23111827" font-family="Arial Black" font-size="40" font-weight="bold">Car Trace</text></svg>') center/contain no-repeat;
        }

        .app-title {
            font-size: 20px;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .app-subtitle {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .sync-status {
            font-size: 12px;
            color: var(--success);
            margin-top: 10px;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 8px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            color: var(--text-primary);
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s;
            font-weight: 500;
            cursor: pointer;
        }

        .nav-link:hover, .nav-link.active {
            background: var(--primary);
            color: white;
            transform: translateX(4px);
        }

        .nav-icon {
            margin-right: 12px;
            font-size: 18px;
        }

        /* Notification Badge */
        .notification-badge {
            background: var(--danger);
            color: white;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: auto;
            animation: pulse 2s infinite;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 30px;
            overflow-y: auto;
        }

        .header {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            padding: 20px 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 28px;
            font-weight: bold;
            color: var(--primary);
        }

        .header-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Content Sections */
        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        /* Cards */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
        }

        .card-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .card-icon {
            margin-right: 10px;
            font-size: 24px;
        }

        /* Vehicle List */
        .vehicle-list {
            display: grid;
            gap: 20px;
        }

        .vehicle-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            border-left: 4px solid var(--primary);
            position: relative;
            display: flex;
            gap: 20px;
        }

        .vehicle-card.stolen {
            border-left-color: var(--danger);
            background: #fef2f2;
        }

        .vehicle-image {
            width: 150px;
            height: 150px;
            border-radius: 8px;
            object-fit: cover;
            flex-shrink: 0;
        }

        .vehicle-content {
            flex: 1;
        }

        .vehicle-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .vehicle-info h3 {
            color: var(--primary);
            margin-bottom: 5px;
        }

        .vehicle-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 13px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-edit {
            background: var(--info);
            color: white;
        }

        .btn-edit:hover {
            background: #2563eb;
        }

        .btn-delete {
            background: var(--danger);
            color: white;
        }

        .btn-delete:hover {
            background: #dc2626;
        }

        .btn-report {
            background: var(--danger);
            color: white;
        }

        .btn-gps {
            background: var(--success);
            color: white;
        }

        .vehicle-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .stolen-badge {
            background: var(--danger);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            position: absolute;
            top: 20px;
            right: 20px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 50px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
        }

        .close-modal {
            font-size: 28px;
            cursor: pointer;
            color: var(--text-secondary);
            background: none;
            border: none;
        }

        .close-modal:hover {
            color: var(--danger);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-select {
            background: white;
            cursor: pointer;
        }

        .form-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            font-size: 16px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-primary:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
            margin-bottom: 10px;
        }

        .btn-secondary:hover {
            background: #1976D2;
        }

        .btn-secondary:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        /* Image Upload */
        .image-upload-area {
            border: 2px dashed #e5e7eb;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .image-upload-area:hover {
            border-color: var(--primary);
            background: #f9fafb;
        }

        .image-upload-area.dragging {
            border-color: var(--primary);
            background: #eff6ff;
        }

        .image-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }

        .image-preview.show {
            display: block;
        }

        .upload-icon {
            font-size: 48px;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .form-helper {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* VIN Lookup Status */
        .vin-lookup-status {
            padding: 10px 15px;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        .vin-lookup-status.show {
            display: flex;
        }

        .vin-lookup-status.loading {
            background: #eff6ff;
            color: var(--info);
            border: 1px solid #bfdbfe;
        }

        .vin-lookup-status.success {
            background: #f0fdf4;
            color: var(--success);
            border: 1px solid #bbf7d0;
        }

        .vin-lookup-status.error {
            background: #fef2f2;
            color: var(--danger);
            border: 1px solid #fecaca;
        }

        .input-group {
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }

        .input-group .form-input {
            flex: 1;
        }

        .input-group .form-select {
            flex: 1;
        }

        /* Map Container */
        #map {
            height: 600px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .alert-popup {
            padding: 10px;
        }

        .alert-popup h4 {
            color: var(--danger);
            margin-bottom: 8px;
        }

        .alert-popup p {
            margin: 4px 0;
            font-size: 13px;
        }

        .alert-popup .btn-small {
            margin-top: 10px;
            width: 100%;
        }

        /* Alert Card */
        .alert-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid var(--danger);
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .alert-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .alert-time {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .alert-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-active {
            background: #fee2e2;
            color: var(--danger);
        }

        .status-recovered {
            background: #d1fae5;
            color: var(--success);
        }

        /* Notification Toast */
        .notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            display: none;
            z-index: 2000;
            max-width: 400px;
        }

        .notification-toast.show {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Step Indicator */
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }

        .step {
            flex: 1;
            text-align: center;
            position: relative;
        }

        .step::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 2px;
            background: #e5e7eb;
            z-index: -1;
        }

        .step:first-child::before {
            left: 50%;
        }

        .step:last-child::before {
            right: 50%;
        }

        .step-number {
            width: 40px;
            height: 40px;
            background: #e5e7eb;
            color: var(--text-secondary);
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .step.active .step-number {
            background: var(--primary);
            color: white;
        }

        .step.completed .step-number {
            background: var(--success);
            color: white;
        }

        .step-label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .form-step {
            display: none;
        }

        .form-step.active {
            display: block;
        }

        /* Insurance Portal */
        .insurance-portal {
            max-width: 1200px;
            margin: 0 auto;
        }

        .portal-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        .portal-tab {
            padding: 12px 24px;
            background: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .portal-tab.active {
            background: var(--primary);
            color: white;
        }

        .insurance-login-form {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .insurance-dashboard {
            display: none;
        }

        .insurance-dashboard.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-label {
            color: var(--text-secondary);
            margin-top: 5px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
            }
            
            .main-content {
                margin-left: 70px;
            }
            
            .nav-link span {
                display: none;
            }
            
            .logo-section .app-title,
            .logo-section .app-subtitle,
            .sync-status {
                display: none;
            }

            .vehicle-card {
                flex-direction: column;
            }

            .vehicle-image {
                width: 100%;
                height: 200px;
            }

            .input-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo-section">
                <div class="app-logo"></div>
                <div class="app-title">CarTrace Pro</div>
                <div class="app-subtitle">Vehicle Protection Network</div>
                <div class="sync-status" id="sync-status">⏳ Syncing...</div>
            </div>
            
            <ul class="nav-menu">
                <li class="nav-item">
                    <a class="nav-link active" onclick="showSection('dashboard')">
                        <span class="nav-icon">🏠</span>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showSection('vehicles')">
                        <span class="nav-icon">🚗</span>
                        <span>My Vehicles</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showSection('map-alerts')">
                        <span class="nav-icon">🗺️</span>
                        <span>Map & Alerts</span>
                        <span class="notification-badge" id="alert-badge">0</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showSection('protection')">
                        <span class="nav-icon">🛡️</span>
                        <span>Protection Plans</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showSection('found-vehicle')">
                        <span class="nav-icon">🔍</span>
                        <span>Found Vehicle</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showSection('insurance')">
                        <span class="nav-icon">🏢</span>
                        <span>Insurance Portal</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showSection('carfax')">
                        <span class="nav-icon">📋</span>
                        <span>Carfax Integration</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showSection('analytics')">
                        <span class="nav-icon">📊</span>
                        <span>Analytics</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showSection('settings')">
                        <span class="nav-icon">⚙️</span>
                        <span>Settings</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="signOut()">
                        <span class="nav-icon">🚪</span>
                        <span>Sign Out</span>
                    </a>
                </li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Section -->
            <div class="content-section active" id="dashboard-section">
                <div class="header">
                    <div>
                        <h1 class="header-title">Welcome Back!</h1>
                        <p id="user-email">Loading...</p>
                    </div>
                    <div class="header-status">
                        <span class="status-dot"></span>
                        <span>Network Active</span>
                    </div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-title">
                            <span class="card-icon">🚗</span>
                            Protected Vehicles
                        </div>
                        <div style="font-size: 36px; font-weight: bold; color: var(--primary); margin: 15px 0;">
                            <span id="vehicle-count">0</span>
                        </div>
                        <div style="color: var(--text-secondary); font-size: 14px;">
                            Active protection plans
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title">
                            <span class="card-icon">🌐</span>
                            Network Status
                        </div>
                        <div style="font-size: 36px; font-weight: bold; color: var(--success); margin: 15px 0;">
                            <span id="active-users">47,892</span>
                        </div>
                        <div style="color: var(--text-secondary); font-size: 14px;">
                            Active community members
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title">
                            <span class="card-icon">🎯</span>
                            Response Time
                        </div>
                        <div style="font-size: 36px; font-weight: bold; color: var(--info); margin: 15px 0;">
                            <span id="response-time">0.8</span>ms
                        </div>
                        <div style="color: var(--text-secondary); font-size: 14px;">
                            Average alert delivery
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">
                        <span class="card-icon">🔔</span>
                        Recent Alerts
                    </div>
                    <div id="recent-alerts">
                        <p style="color: var(--text-secondary); text-align: center; padding: 20px;">
                            No recent alerts in your area. Your vehicles are safe! ✅
                        </p>
                    </div>
                </div>
            </div>

            <!-- My Vehicles Section -->
            <div class="content-section" id="vehicles-section">
                <div class="header">
                    <h1 class="header-title">My Vehicles</h1>
                    <button class="btn btn-primary" onclick="showAddVehicleModal()" style="width: auto;">
                        + Add Vehicle
                    </button>
                </div>

                <div class="vehicle-list" id="vehicle-list">
                    <p style="text-align: center; color: var(--text-secondary); padding: 40px;">
                        No vehicles added yet. Click "Add Vehicle" to get started!
                    </p>
                </div>
            </div>

            <!-- Map & Alerts Section -->
            <div class="content-section" id="map-alerts-section">
                <div class="header">
                    <h1 class="header-title">Live Map & Stolen Vehicle Alerts</h1>
                    <div class="header-status">
                        <span class="status-dot"></span>
                        <span>Real-Time Tracking Active</span>
                    </div>
                </div>

                <div class="cards-grid" style="margin-bottom: 20px;">
                    <div class="card">
                        <div class="card-title">
                            <span class="card-icon">🚨</span>
                            Active Alerts
                        </div>
                        <div style="font-size: 36px; font-weight: bold; color: var(--danger); margin: 15px 0;">
                            <span id="active-alerts-count">0</span>
                        </div>
                        <div style="color: var(--text-secondary); font-size: 14px;">
                            Stolen vehicles in your area
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title">
                            <span class="card-icon">📍</span>
                            Your Location
                        </div>
                        <div style="font-size: 16px; font-weight: bold; color: var(--primary); margin: 15px 0;">
                            <span id="user-location">Detecting...</span>
                        </div>
                        <div style="color: var(--text-secondary); font-size: 14px;">
                            Current position
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title">
                            <span class="card-icon">✅</span>
                            Recoveries
                        </div>
                        <div style="font-size: 36px; font-weight: bold; color: var(--success); margin: 15px 0;">
                            1,247
                        </div>
                        <div style="color: var(--text-secondary); font-size: 14px;">
                            Total vehicles recovered
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-bottom: 20px;">
                    <div id="map"></div>
                </div>

                <div class="card">
                    <div class="card-title">
                        <span class="card-icon">📋</span>
                        Alert Details
                    </div>
                    <div id="alerts-list">
                        <p style="text-align: center; color: var(--text-secondary); padding: 20px;">
                            No active alerts at this time.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Protection Plans Section -->
            <div class="content-section" id="protection-section">
                <div class="header">
                    <h1 class="header-title">Protection Plans</h1>
                </div>

                <div class="cards-grid">
                    <div class="card" style="border: 2px solid var(--info);">
                        <div class="card-title">
                            <span class="card-icon">🥉</span>
                            Basic Protection
                        </div>
                        <div style="font-size: 32px; font-weight: bold; color: var(--primary); margin: 15px 0;">
                            $17.99<span style="font-size: 16px;">/mo</span>
                        </div>
                        <ul style="list-style: none; padding: 0; color: var(--text-secondary);">
                            <li style="padding: 8px 0;">✅ Community alerts</li>
                            <li style="padding: 8px 0;">✅ GPS tracking</li>
                            <li style="padding: 8px 0;">✅ $200 recovery reward</li>
                            <li style="padding: 8px 0;">✅ 24/7 support</li>
                        </ul>
                        <button class="btn btn-primary" onclick="startCheckout('basic')">Select Plan</button>
                    </div>

                    <div class="card" style="border: 2px solid var(--warning);">
                        <div class="card-title">
                            <span class="card-icon">🥈</span>
                            Gold Protection
                        </div>
                        <div style="font-size: 32px; font-weight: bold; color: var(--primary); margin: 15px 0;">
                            $24.99<span style="font-size: 16px;">/mo</span>
                        </div>
                        <ul style="list-style: none; padding: 0; color: var(--text-secondary);">
                            <li style="padding: 8px 0;">✅ All Basic features</li>
                            <li style="padding: 8px 0;">✅ Priority alerts</li>
                            <li style="padding: 8px 0;">✅ $300 recovery reward</li>
                            <li style="padding: 8px 0;">✅ Insurance integration</li>
                        </ul>
                        <button class="btn btn-primary" onclick="startCheckout('gold')">Select Plan</button>
                    </div>

                    <div class="card" style="border: 2px solid #c0c0c0;">
                        <div class="card-title">
                            <span class="card-icon">🥇</span>
                            Platinum Protection
                        </div>
                        <div style="font-size: 32px; font-weight: bold; color: var(--primary); margin: 15px 0;">
                            $29.99<span style="font-size: 16px;">/mo</span>
                        </div>
                        <ul style="list-style: none; padding: 0; color: var(--text-secondary);">
                            <li style="padding: 8px 0;">✅ All Gold features</li>
                            <li style="padding: 8px 0;">✅ Real-time tracking</li>
                            <li style="padding: 8px 0;">✅ $500 recovery reward</li>
                            <li style="padding: 8px 0;">✅ Carfax integration</li>
                        </ul>
                        <button class="btn btn-primary" onclick="startCheckout('platinum')">Select Plan</button>
                    </div>

                    <div class="card" style="border: 2px solid var(--primary);">
                        <div class="card-title">
                            <span class="card-icon">💎</span>
                            Diamond Protection
                        </div>
                        <div style="font-size: 32px; font-weight: bold; color: var(--primary); margin: 15px 0;">
                            $35.00<span style="font-size: 16px;">/mo</span>
                        </div>
                        <ul style="list-style: none; padding: 0; color: var(--text-secondary);">
                            <li style="padding: 8px 0;">✅ All Platinum features</li>
                            <li style="padding: 8px 0;">✅ Instant alerts</li>
                            <li style="padding: 8px 0;">✅ $750 recovery reward</li>
                            <li style="padding: 8px 0;">✅ Dedicated support</li>
                        </ul>
                        <button class="btn btn-primary" onclick="startCheckout('diamond')">Select Plan</button>
                    </div>
                </div>
            </div>

            <!-- Found Vehicle Section -->
            <div class="content-section" id="found-vehicle-section">
                <div class="header">
                    <h1 class="header-title">Report Found Stolen Vehicle</h1>
                </div>

                <div class="card">
                    <p style="margin-bottom: 20px; color: var(--text-secondary);">
                        Help recover stolen vehicles and earn rewards! If you've spotted a vehicle with an active theft alert, report it here.
                    </p>

                    <form id="found-vehicle-form">
                        <div class="form-group">
                            <label class="form-label">License Plate Number *</label>
                            <input type="text" class="form-input" id="found-plate" required placeholder="Enter plate number">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Current Location *</label>
                            <input type="text" class="form-input" id="found-location" required placeholder="Street address or landmark">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Police Report Number *</label>
                            <input type="text" class="form-input" id="found-report" required placeholder="Report #">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Police Department *</label>
                            <input type="text" class="form-input" id="found-department" required placeholder="Department name">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Your Zelle Contact (for reward) *</label>
                            <input type="text" class="form-input" id="found-zelle" required placeholder="Phone or email">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Witness Information (Optional)</label>
                            <input type="text" class="form-input" id="found-witness" placeholder="Name and contact">
                        </div>

                        <button type="submit" class="btn btn-primary">Submit Report & Earn Reward</button>
                    </form>
                </div>
            </div>

            <!-- Insurance Portal Section -->
            <div class="content-section" id="insurance-section">
                <div class="header">
                    <h1 class="header-title">Insurance Company Portal</h1>
                </div>

                <div class="insurance-portal">
                    <div class="insurance-login-form" id="insurance-login">
                        <h3 style="text-align: center; margin-bottom: 20px;">Insurance Partner Login</h3>
                        <form id="insurance-login-form">
                            <div class="form-group">
                                <label class="form-label">Company Email</label>
                                <input type="email" class="form-input" required placeholder="admin@insurance.com">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Password</label>
                                <input type="password" class="form-input" required placeholder="Enter password">
                            </div>
                            <button type="submit" class="btn btn-primary">Access Portal</button>
                        </form>
                    </div>

                    <div class="insurance-dashboard" id="insurance-dashboard">
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value">$2.1M</div>
                                <div class="stat-label">Claims Prevented</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">156</div>
                                <div class="stat-label">Active Policies</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">98.5%</div>
                                <div class="stat-label">Recovery Rate</div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-title">
                                <span class="card-icon">📋</span>
                                Recent Claims
                            </div>
                            <p style="color: var(--text-secondary); padding: 20px; text-align: center;">
                                No pending claims at this time.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Carfax Section -->
            <div class="content-section" id="carfax-section">
                <div class="header">
                    <h1 class="header-title">Carfax Integration</h1>
                </div>

                <div class="card">
                    <div class="card-title">
                        <span class="card-icon">📋</span>
                        Connect Your Carfax Account
                    </div>
                    <p style="margin-bottom: 20px; color: var(--text-secondary);">
                        Link your Carfax Car Care account for enhanced vehicle tracking and maintenance alerts.
                    </p>
                    <button class="btn btn-primary" onclick="connectCarfax()">Connect Carfax</button>
                </div>
            </div>

            <!-- Analytics Section -->
            <div class="content-section" id="analytics-section">
                <div class="header">
                    <h1 class="header-title">Network Analytics</h1>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-title">
                            <span class="card-icon">⏱️</span>
                            Network Uptime
                        </div>
                        <div style="font-size: 36px; font-weight: bold; color: var(--success); margin: 15px 0;">
                            <span id="network-uptime">99.95</span>%
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title">
                            <span class="card-icon">🔒</span>
                            Security Score
                        </div>
                        <div style="font-size: 36px; font-weight: bold; color: var(--success); margin: 15px 0;">
                            <span id="security-score">98</span>/100
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title">
                            <span class="card-icon">📊</span>
                            Data Points
                        </div>
                        <div style="font-size: 36px; font-weight: bold; color: var(--info); margin: 15px 0;">
                            <span id="data-points">1,234,567</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Section -->
            <div class="content-section" id="settings-section">
                <div class="header">
                    <h1 class="header-title">Account Settings</h1>
                </div>

                <div class="card">
                    <div class="card-title">
                        <span class="card-icon">👤</span>
                        Profile Information
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        <input type="email" class="form-input" id="settings-email" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Member Since</label>
                        <input type="text" class="form-input" id="member-since" readonly>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">
                        <span class="card-icon">🔔</span>
                        Notification Preferences
                    </div>
                    <div style="padding: 10px 0;">
                        <label style="display: flex; align-items: center; margin-bottom: 15px;">
                            <input type="checkbox" checked style="margin-right: 10px;">
                            <span>Email notifications for stolen vehicle alerts</span>
                        </label>
                        <label style="display: flex; align-items: center; margin-bottom: 15px;">
                            <input type="checkbox" checked style="margin-right: 10px;">
                            <span>Push notifications for nearby alerts</span>
                        </label>
                        <label style="display: flex; align-items: center;">
                            <input type="checkbox" checked style="margin-right: 10px;">
                            <span>Weekly network activity summaries</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Vehicle Modal with VIN Auto-Lookup -->
    <div class="modal" id="add-vehicle-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add New Vehicle</h2>
                <button class="close-modal" onclick="closeAddVehicleModal()">&times;</button>
            </div>

            <form id="add-vehicle-form">
                <!-- Image Upload -->
                <div class="form-group">
                    <label class="form-label">Vehicle Photo *</label>
                    <div class="image-upload-area" id="image-upload-area" onclick="document.getElementById('vehicle-image').click()">
                        <div class="upload-icon">📸</div>
                        <div style="color: var(--text-secondary); font-size: 14px;">
                            <strong style="color: var(--primary);">Click to upload</strong> or drag and drop<br>
                            <small>PNG, JPG, JPEG up to 5MB</small>
                        </div>
                    </div>
                    <input type="file" id="vehicle-image" accept="image/*" style="display: none;" required>
                    <img id="image-preview" class="image-preview" alt="Vehicle preview">
                </div>

                <!-- License Plate and State with Auto VIN Lookup -->
                <div class="form-group">
                    <label class="form-label">License Plate & State *</label>
                    <div class="input-group">
                        <input type="text" class="form-input" id="add-plate" required placeholder="ABC123" style="text-transform: uppercase;">
                        <select class="form-select" id="add-state" required>
                            <option value="">Select State</option>
                            <option value="AL">Alabama</option>
                            <option value="AK">Alaska</option>
                            <option value="AZ">Arizona</option>
                            <option value="AR">Arkansas</option>
                            <option value="CA">California</option>
                            <option value="CO">Colorado</option>
                            <option value="CT">Connecticut</option>
                            <option value="DE">Delaware</option>
                            <option value="FL">Florida</option>
                            <option value="GA">Georgia</option>
                            <option value="HI">Hawaii</option>
                            <option value="ID">Idaho</option>
                            <option value="IL">Illinois</option>
                            <option value="IN">Indiana</option>
                            <option value="IA">Iowa</option>
                            <option value="KS">Kansas</option>
                            <option value="KY">Kentucky</option>
                            <option value="LA">Louisiana</option>
                            <option value="ME">Maine</option>
                            <option value="MD">Maryland</option>
                            <option value="MA">Massachusetts</option>
                            <option value="MI">Michigan</option>
                            <option value="MN">Minnesota</option>
                            <option value="MS">Mississippi</option>
                            <option value="MO">Missouri</option>
                            <option value="MT">Montana</option>
                            <option value="NE">Nebraska</option>
                            <option value="NV">Nevada</option>
                            <option value="NH">New Hampshire</option>
                            <option value="NJ">New Jersey</option>
                            <option value="NM">New Mexico</option>
                            <option value="NY">New York</option>
                            <option value="NC">North Carolina</option>
                            <option value="ND">North Dakota</option>
                            <option value="OH">Ohio</option>
                            <option value="OK">Oklahoma</option>
                            <option value="OR">Oregon</option>
                            <option value="PA">Pennsylvania</option>
                            <option value="RI">Rhode Island</option>
                            <option value="SC">South Carolina</option>
                            <option value="SD">South Dakota</option>
                            <option value="TN">Tennessee</option>
                            <option value="TX">Texas</option>
                            <option value="UT">Utah</option>
                            <option value="VT">Vermont</option>
                            <option value="VA">Virginia</option>
                            <option value="WA">Washington</option>
                            <option value="WV">West Virginia</option>
                            <option value="WI">Wisconsin</option>
                            <option value="WY">Wyoming</option>
                            <option value="DC">Washington DC</option>
                        </select>
                    </div>
                    <button type="button" class="btn btn-secondary" id="lookup-vin-btn" onclick="lookupVIN()">
                        🔍 Auto-Lookup VIN
                    </button>
                    <div class="vin-lookup-status" id="vin-lookup-status"></div>
                </div>

                <!-- VIN (Auto-filled or Manual) -->
                <div class="form-group">
                    <label class="form-label">VIN (Vehicle Identification Number)</label>
                    <input type="text" class="form-input" id="add-vin" maxlength="17" placeholder="Will be auto-filled from lookup or enter manually">
                    <div class="form-helper">VIN will be automatically filled from lookup, or you can enter it manually</div>
                </div>

                <!-- Year Dropdown -->
                <div class="form-group">
                    <label class="form-label">Year *</label>
                    <select class="form-select" id="add-year" required>
                        <option value="">Select Year</option>
                    </select>
                    <div class="form-helper">Will be auto-filled from VIN lookup if available</div>
                </div>

                <!-- Make Dropdown -->
                <div class="form-group">
                    <label class="form-label">Make *</label>
                    <select class="form-select" id="add-make" required onchange="updateModels()">
                        <option value="">Select Make</option>
                    </select>
                    <div class="form-helper">Will be auto-filled from VIN lookup if available</div>
                </div>

                <!-- Model Dropdown -->
                <div class="form-group">
                    <label class="form-label">Model *</label>
                    <select class="form-select" id="add-model" required>
                        <option value="">Select Make First</option>
                    </select>
                    <div class="form-helper">Select "Other/Custom" for special or custom vehicles</div>
                </div>

                <!-- Custom Model Input -->
                <div class="form-group" id="custom-model-group" style="display: none;">
                    <label class="form-label">Custom Model Name *</label>
                    <input type="text" class="form-input" id="custom-model" placeholder="e.g., GT-R Nismo, Custom Build">
                </div>

                <!-- Color Dropdown -->
                <div class="form-group">
                    <label class="form-label">Color *</label>
                    <select class="form-select" id="add-color" required>
                        <option value="">Select Color</option>
                        <optgroup label="Common Colors">
                            <option value="Black">Black</option>
                            <option value="White">White</option>
                            <option value="Silver">Silver</option>
                            <option value="Gray">Gray</option>
                            <option value="Red">Red</option>
                            <option value="Blue">Blue</option>
                            <option value="Green">Green</option>
                            <option value="Yellow">Yellow</option>
                            <option value="Orange">Orange</option>
                            <option value="Brown">Brown</option>
                            <option value="Beige">Beige</option>
                            <option value="Gold">Gold</option>
                        </optgroup>
                        <optgroup label="Metallic Colors">
                            <option value="Metallic Black">Metallic Black</option>
                            <option value="Metallic Silver">Metallic Silver</option>
                            <option value="Metallic Gray">Metallic Gray</option>
                            <option value="Metallic Blue">Metallic Blue</option>
                            <option value="Metallic Red">Metallic Red</option>
                            <option value="Metallic Green">Metallic Green</option>
                            <option value="Metallic Bronze">Metallic Bronze</option>
                            <option value="Metallic Gold">Metallic Gold</option>
                        </optgroup>
                        <optgroup label="Premium Colors">
                            <option value="Pearl White">Pearl White</option>
                            <option value="Midnight Blue">Midnight Blue</option>
                            <option value="Deep Sea Blue">Deep Sea Blue</option>
                            <option value="Racing Red">Racing Red</option>
                            <option value="Candy Apple Red">Candy Apple Red</option>
                            <option value="British Racing Green">British Racing Green</option>
                            <option value="Champagne">Champagne</option>
                            <option value="Burgundy">Burgundy</option>
                            <option value="Navy Blue">Navy Blue</option>
                            <option value="Forest Green">Forest Green</option>
                        </optgroup>
                        <optgroup label="Matte/Special Finishes">
                            <option value="Matte Black">Matte Black</option>
                            <option value="Matte Gray">Matte Gray</option>
                            <option value="Matte White">Matte White</option>
                            <option value="Matte Blue">Matte Blue</option>
                            <option value="Matte Red">Matte Red</option>
                            <option value="Satin Black">Satin Black</option>
                            <option value="Chrome">Chrome</option>
                            <option value="Rose Gold">Rose Gold</option>
                        </optgroup>
                        <optgroup label="Other">
                            <option value="Two-Tone">Two-Tone</option>
                            <option value="Custom Wrap">Custom Wrap</option>
                            <option value="Custom Paint">Custom Paint</option>
                            <option value="Other">Other</option>
                        </optgroup>
                    </select>
                </div>

                <!-- Custom Details -->
                <div class="form-group">
                    <label class="form-label">Custom Details (Optional)</label>
                    <textarea class="form-textarea" id="add-custom-details" placeholder="Add custom details like:
• Custom wheels (Forgiato, BBS, HRE, etc.)
• Body modifications (carbon fiber wing, widebody kit, etc.)
• Performance upgrades (turbo, supercharger, exhaust, etc.)
• Paint/Wrap details
• Interior modifications"></textarea>
                </div>

                <!-- Protection Plan -->
                <div class="form-group">
                    <label class="form-label">Protection Plan *</label>
                    <select class="form-select" id="add-plan" required>
                        <option value="basic">Basic - $17.99/mo</option>
                        <option value="gold">Gold - $24.99/mo</option>
                        <option value="platinum">Platinum - $29.99/mo</option>
                        <option value="diamond">Diamond - $35.00/mo</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-primary" id="submit-btn">
                    Add Vehicle & Pay
                </button>
            </form>
        </div>
    </div>

    <!-- Report Stolen Vehicle Modal (Multi-Step) -->
    <div class="modal" id="report-stolen-modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title">Report Stolen Vehicle</h2>
                <button class="close-modal" onclick="closeReportStolenModal()">&times;</button>
            </div>

            <!-- Step Indicator -->
            <div class="step-indicator">
                <div class="step active" id="step-1-indicator">
                    <div class="step-number">1</div>
                    <div class="step-label">Vehicle Info</div>
                </div>
                <div class="step" id="step-2-indicator">
                    <div class="step-number">2</div>
                    <div class="step-label">Police Report</div>
                </div>
                <div class="step" id="step-3-indicator">
                    <div class="step-number">3</div>
                    <div class="step-label">Details</div>
                </div>
            </div>

            <form id="report-stolen-form">
                <!-- Step 1: Vehicle Selection -->
                <div class="form-step active" id="step-1">
                    <div class="form-group">
                        <label class="form-label">Select Your Vehicle *</label>
                        <select class="form-select" id="stolen-vehicle-select" required>
                            <option value="">Choose a vehicle</option>
                        </select>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="nextStep(2)">Next: Police Report</button>
                </div>

                <!-- Step 2: Police Info -->
                <div class="form-step" id="step-2">
                    <div class="form-group">
                        <label class="form-label">Police Report Number *</label>
                        <input type="text" class="form-input" id="stolen-report-number" placeholder="Report #123456">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Police Department *</label>
                        <input type="text" class="form-input" id="stolen-department" placeholder="City Police Department">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Officer Name *</label>
                        <input type="text" class="form-input" id="stolen-officer" placeholder="Officer John Smith">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date/Time Stolen *</label>
                        <input type="datetime-local" class="form-input" id="stolen-datetime">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button type="button" class="btn btn-secondary" onclick="nextStep(1)">Back</button>
                        <button type="button" class="btn btn-primary" onclick="nextStep(3)">Next: Details</button>
                    </div>
                </div>

                <!-- Step 3: Additional Details -->
                <div class="form-step" id="step-3">
                    <div class="form-group">
                        <label class="form-label">Last Known Location *</label>
                        <input type="text" class="form-input" id="stolen-location" placeholder="Street address or landmark">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Circumstances</label>
                        <textarea class="form-textarea" id="stolen-circumstances" placeholder="Describe how the vehicle was stolen..."></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Witness Information (Optional)</label>
                        <input type="text" class="form-input" id="stolen-witness" placeholder="Name and contact">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button type="button" class="btn btn-secondary" onclick="nextStep(2)">Back</button>
                        <button type="submit" class="btn btn-primary">Submit Theft Report</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Vehicle Modal -->
    <div class="modal" id="edit-vehicle-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Edit Vehicle</h2>
                <button class="close-modal" onclick="closeEditModal()">&times;</button>
            </div>
            <form id="edit-vehicle-form">
                <input type="hidden" id="edit-vehicle-id">
                
                <div class="form-group">
                    <label class="form-label">VIN (Optional)</label>
                    <input type="text" class="form-input" id="edit-vin" maxlength="17" placeholder="Enter 17-digit VIN">
                </div>

                <div class="form-group">
                    <label class="form-label">Protection Plan</label>
                    <select class="form-select" id="edit-plan" required>
                        <option value="basic">Basic - $17.99/mo</option>
                        <option value="gold">Gold - $24.99/mo</option>
                        <option value="platinum">Platinum - $29.99/mo</option>
                        <option value="diamond">Diamond - $35.00/mo</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">License Plate</label>
                    <input type="text" class="form-input" id="edit-plate" readonly>
                </div>

                <button type="submit" class="btn btn-primary">Save Changes</button>
            </form>
        </div>
    </div>

    <!-- Notification Toast -->
    <div class="notification-toast" id="notification-toast">
        <div style="display: flex; align-items: start; gap: 15px;">
            <div style="font-size: 32px;">🚨</div>
            <div>
                <h4 style="margin-bottom: 8px; color: var(--danger);" id="toast-title">Stolen Vehicle Alert</h4>
                <p style="color: var(--text-secondary); margin-bottom: 10px;" id="toast-message"></p>
                <button class="btn-small btn-primary" onclick="closeToast()">View Details</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize Stripe
        const stripe = Stripe('pk_test_51QeTZeRxPKUgpxLKOOPLpxDGJoCF3u7QmGqBjsVqRJZuEcAzQ1JW4iqh6XxGIONhL9o7JnqkdPcXzFYt8bPbvC6x009cz5i5rT');

        // Global Variables
        let map, userMarker;
        let alertMarkers = [];
        let stolenVehicles = [];
        let currentStep = 1;

        // Vehicle Database
        const vehicleDatabase = {
            'Acura': ['CL', 'CSX', 'ILX', 'Integra', 'Legend', 'MDX', 'NSX', 'RDX', 'RL', 'RLX', 'RSX', 'TL', 'TLX', 'TSX', 'ZDX', 'Other/Custom'],
            'Audi': ['A3', 'A4', 'A5', 'A6', 'A7', 'A8', 'Q3', 'Q4 e-tron', 'Q5', 'Q7', 'Q8', 'R8', 'RS3', 'RS4', 'RS5', 'RS6', 'RS7', 'S3', 'S4', 'S5', 'S6', 'TT', 'e-tron', 'Other/Custom'],
            'BMW': ['1 Series', '2 Series', '3 Series', '4 Series', '5 Series', '6 Series', '7 Series', '8 Series', 'M2', 'M3', 'M4', 'M5', 'M8', 'X1', 'X2', 'X3', 'X4', 'X5', 'X6', 'X7', 'Z4', 'i3', 'i4', 'i8', 'iX', 'Other/Custom'],
            'Chevrolet': ['Blazer', 'Bolt', 'Camaro', 'Colorado', 'Corvette', 'Cruze', 'Equinox', 'Impala', 'Malibu', 'Silverado', 'Spark', 'Suburban', 'Tahoe', 'Traverse', 'Trax', 'Volt', 'Other/Custom'],
            'Dodge': ['Challenger', 'Charger', 'Dart', 'Durango', 'Grand Caravan', 'Journey', 'Ram', 'Viper', 'Other/Custom'],
            'Ferrari': ['296 GTB', '458', '488', '812', 'California', 'F8', 'LaFerrari', 'Portofino', 'Roma', 'SF90', 'Other/Custom'],
            'Ford': ['Bronco', 'Edge', 'Escape', 'Expedition', 'Explorer', 'F-150', 'F-250', 'Fiesta', 'Focus', 'Fusion', 'Maverick', 'Mustang', 'Ranger', 'Taurus', 'Other/Custom'],
            'Honda': ['Accord', 'CR-V', 'Civic', 'Clarity', 'Fit', 'HR-V', 'Insight', 'Odyssey', 'Passport', 'Pilot', 'Ridgeline', 'Other/Custom'],
            'Hyundai': ['Accent', 'Elantra', 'Ioniq', 'Kona', 'Palisade', 'Santa Cruz', 'Santa Fe', 'Sonata', 'Tucson', 'Veloster', 'Venue', 'Other/Custom'],
            'Jeep': ['Cherokee', 'Compass', 'Gladiator', 'Grand Cherokee', 'Renegade', 'Wrangler', 'Other/Custom'],
            'Lamborghini': ['Aventador', 'Huracan', 'Revuelto', 'Urus', 'Other/Custom'],
            'Lexus': ['CT', 'ES', 'GS', 'GX', 'IS', 'LC', 'LS', 'LX', 'NX', 'RC', 'RX', 'UX', 'Other/Custom'],
            'Mercedes-Benz': ['A-Class', 'AMG GT', 'C-Class', 'CLA', 'CLS', 'E-Class', 'EQC', 'EQS', 'G-Class', 'GLA', 'GLB', 'GLC', 'GLE', 'GLS', 'S-Class', 'SL', 'Other/Custom'],
            'Nissan': ['Altima', 'Armada', 'Frontier', 'GT-R', 'Kicks', 'Leaf', 'Maxima', 'Murano', 'Pathfinder', 'Rogue', 'Sentra', 'Titan', 'Versa', 'Z', 'Other/Custom'],
            'Porsche': ['911', 'Boxster', 'Cayenne', 'Cayman', 'Macan', 'Panamera', 'Taycan', 'Other/Custom'],
            'Tesla': ['Cybertruck', 'Model 3', 'Model S', 'Model X', 'Model Y', 'Roadster', 'Other/Custom'],
            'Toyota': ['4Runner', '86', 'Avalon', 'Camry', 'Corolla', 'GR Supra', 'Highlander', 'Land Cruiser', 'Prius', 'RAV4', 'Sequoia', 'Sienna', 'Tacoma', 'Tundra', 'Venza', 'Yaris', 'Other/Custom'],
            'Volkswagen': ['Arteon', 'Atlas', 'Golf', 'GTI', 'ID.4', 'Jetta', 'Passat', 'Taos', 'Tiguan', 'Other/Custom'],
            'Other/Custom': ['Custom Build', 'Kit Car', 'Modified Vehicle', 'Specialty Vehicle', 'Classic/Vintage', 'Exotic/Rare', 'Other']
        };

        // VIN Lookup Function
        async function lookupVIN() {
            const licensePlate = document.getElementById('add-plate').value.trim().toUpperCase();
            const state = document.getElementById('add-state').value;
            const statusDiv = document.getElementById('vin-lookup-status');
            const lookupBtn = document.getElementById('lookup-vin-btn');

            if (!licensePlate || !state) {
                alert('Please enter both license plate and select a state first');
                return;
            }

            statusDiv.className = 'vin-lookup-status loading show';
            statusDiv.innerHTML = '<span class="loading-spinner"></span> Looking up vehicle information...';
            lookupBtn.disabled = true;

            try {
                const response = await fetch('http://localhost:3000/lookup-vin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ licensePlate, state })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    statusDiv.className = 'vin-lookup-status success show';
                    statusDiv.innerHTML = '✓ Vehicle information found and auto-filled!';

                    if (data.vin) document.getElementById('add-vin').value = data.vin;
                    if (data.year) document.getElementById('add-year').value = data.year;
                    
                    if (data.make) {
                        const makeSelect = document.getElementById('add-make');
                        const makeValue = findClosestMake(data.make);
                        if (makeValue) {
                            makeSelect.value = makeValue;
                            updateModels();
                            
                            setTimeout(() => {
                                if (data.model) {
                                    const modelSelect = document.getElementById('add-model');
                                    const modelValue = findClosestModel(makeValue, data.model);
                                    if (modelValue) modelSelect.value = modelValue;
                                }
                            }, 100);
                        }
                    }

                    if (data.color) {
                        const colorSelect = document.getElementById('add-color');
                        const colorOption = Array.from(colorSelect.options).find(
                            opt => opt.value.toLowerCase() === data.color.toLowerCase()
                        );
                        if (colorOption) colorSelect.value = colorOption.value;
                    }

                    setTimeout(() => statusDiv.classList.remove('show'), 5000);
                } else {
                    statusDiv.className = 'vin-lookup-status error show';
                    statusDiv.innerHTML = '⚠️ ' + (data.message || 'Vehicle information not found. Please enter details manually.');
                    setTimeout(() => statusDiv.classList.remove('show'), 5000);
                }
            } catch (error) {
                console.error('VIN lookup error:', error);
                statusDiv.className = 'vin-lookup-status error show';
                statusDiv.innerHTML = '⚠️ Error connecting to lookup service. Please enter details manually.';
                setTimeout(() => statusDiv.classList.remove('show'), 5000);
            } finally {
                lookupBtn.disabled = false;
            }
        }

        function findClosestMake(apiMake) {
            const normalized = apiMake.toUpperCase().trim();
            for (let make in vehicleDatabase) {
                if (make.toUpperCase() === normalized) return make;
            }
            for (let make in vehicleDatabase) {
                if (make.toUpperCase().includes(normalized) || normalized.includes(make.toUpperCase())) return make;
            }
            return 'Other/Custom';
        }

        function findClosestModel(make, apiModel) {
            if (!vehicleDatabase[make]) return null;
            const normalized = apiModel.toUpperCase().trim();
            const models = vehicleDatabase[make];
            for (let model of models) {
                if (model.toUpperCase() === normalized) return model;
            }
            for (let model of models) {
                if (model.toUpperCase().includes(normalized) || normalized.includes(model.toUpperCase())) return model;
            }
            return 'Other/Custom';
        }

        // Populate year dropdown
        function populateYears() {
            const yearSelect = document.getElementById('add-year');
            for (let year = 2026; year >= 1990; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }
        }

        // Populate makes dropdown
        function populateMakes() {
            const makeSelect = document.getElementById('add-make');
            const makes = Object.keys(vehicleDatabase).sort();
            makes.forEach(make => {
                const option = document.createElement('option');
                option.value = make;
                option.textContent = make;
                makeSelect.appendChild(option);
            });
        }

        // Update models based on selected make
        function updateModels() {
            const make = document.getElementById('add-make').value;
            const modelSelect = document.getElementById('add-model');
            const customModelGroup = document.getElementById('custom-model-group');
            
            modelSelect.innerHTML = '<option value="">Select Model</option>';
            
            if (make && vehicleDatabase[make]) {
                vehicleDatabase[make].forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = model;
                    modelSelect.appendChild(option);
                });
            }

            modelSelect.onchange = function() {
                if (this.value === 'Other/Custom') {
                    customModelGroup.style.display = 'block';
                    document.getElementById('custom-model').required = true;
                } else {
                    customModelGroup.style.display = 'none';
                    document.getElementById('custom-model').required = false;
                }
            };
        }

        // Image upload handling
        const imageInput = document.getElementById('vehicle-image');
        const imagePreview = document.getElementById('image-preview');
        const imageUploadArea = document.getElementById('image-upload-area');

        imageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) {
                    alert('Image size must be less than 5MB');
                    this.value = '';
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.src = e.target.result;
                    imagePreview.classList.add('show');
                };
                reader.readAsDataURL(file);
            }
        });

        // Drag and drop
        imageUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            imageUploadArea.classList.add('dragging');
        });

        imageUploadArea.addEventListener('dragleave', () => {
            imageUploadArea.classList.remove('dragging');
        });

        imageUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            imageUploadArea.classList.remove('dragging');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                imageInput.files = e.dataTransfer.files;
                imageInput.dispatchEvent(new Event('change'));
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            populateYears();
            populateMakes();
            
            // Initialize map
            if (document.getElementById('map')) {
                try {
                    map = L.map('map').setView([26.1420, -81.7948], 13); // Naples, FL
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '© OpenStreetMap contributors'
                    }).addTo(map);
                    
                    // Get user location
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition((position) => {
                            const lat = position.coords.latitude;
                            const lng = position.coords.longitude;
                            
                            map.setView([lat, lng], 13);
                            
                            userMarker = L.marker([lat, lng], {
                                icon: L.divIcon({
                                    className: 'user-marker',
                                    html: '<div style="background: #4f46e5; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">📍</div>'
                                })
                            }).addTo(map);
                            
                            document.getElementById('user-location').textContent = 'Naples, FL';
                        });
                    }
                } catch(e) {
                    console.error('Map initialization error:', e);
                }
            }
            
            // Start live stats updates
            setInterval(updateLiveStats, 3000);
            
            // Update sync status
            setTimeout(() => {
                document.getElementById('sync-status').textContent = '✅ Community network connected';
                document.getElementById('sync-status').style.color = 'var(--success)';
            }, 2000);
        });

        // Navigation
        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.getElementById(sectionId + '-section').classList.add('active');
            event.target.closest('.nav-link').classList.add('active');
            
            if (sectionId === 'map-alerts' && map) {
                setTimeout(() => map.invalidateSize(), 100);
            }
        }

        // Modal functions
        function showAddVehicleModal() {
            document.getElementById('add-vehicle-modal').classList.add('active');
        }

        function closeAddVehicleModal() {
            document.getElementById('add-vehicle-modal').classList.remove('active');
            document.getElementById('add-vehicle-form').reset();
            document.getElementById('custom-model-group').style.display = 'none';
            document.getElementById('vin-lookup-status').classList.remove('show');
            imagePreview.classList.remove('show');
        }

        function showReportStolenModal(vehicleId) {
            document.getElementById('report-stolen-modal').classList.add('active');
            
            // Populate vehicle select
            const select = document.getElementById('stolen-vehicle-select');
            select.innerHTML = '<option value="">Choose a vehicle</option>';
            
            if (window.userVehicles) {
                window.userVehicles.forEach(v => {
                    const option = document.createElement('option');
                    option.value = v.id;
                    option.textContent = `${v.year} ${v.make} ${v.model} (${v.licensePlate})`;
                    if (v.id === vehicleId) option.selected = true;
                    select.appendChild(option);
                });
            }
            
            currentStep = 1;
            showStep(1);
        }

        function closeReportStolenModal() {
            document.getElementById('report-stolen-modal').classList.remove('active');
            document.getElementById('report-stolen-form').reset();
            currentStep = 1;
            showStep(1);
        }

        function nextStep(step) {
            currentStep = step;
            showStep(step);
        }

        function showStep(step) {
            document.querySelectorAll('.form-step').forEach(s => s.classList.remove('active'));
            document.querySelector(`#step-${step}`).classList.add('active');
            
            document.querySelectorAll('.step').forEach((s, i) => {
                s.classList.remove('active', 'completed');
                if (i + 1 === step) s.classList.add('active');
                if (i + 1 < step) s.classList.add('completed');
            });
        }

        function closeEditModal() {
            document.getElementById('edit-vehicle-modal').classList.remove('active');
        }

        function closeToast() {
            document.getElementById('notification-toast').classList.remove('show');
        }

        function updateVehicleDisplay() {
            const vehicleList = document.getElementById('vehicle-list');
            
            if (!window.userVehicles || window.userVehicles.length === 0) {
                vehicleList.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 40px;">No vehicles added yet.</p>';
                return;
            }

            vehicleList.innerHTML = window.userVehicles.map(vehicle => `
                <div class="vehicle-card ${vehicle.stolen ? 'stolen' : ''}">
                    ${vehicle.stolen ? '<span class="stolen-badge">🚨 STOLEN</span>' : ''}
                    ${vehicle.imageUrl ? `<img src="${vehicle.imageUrl}" class="vehicle-image" alt="${vehicle.year} ${vehicle.make} ${vehicle.model}">` : ''}
                    <div class="vehicle-content">
                        <div class="vehicle-header">
                            <div class="vehicle-info">
                                <h3>${vehicle.year} ${vehicle.make} ${vehicle.model}</h3>
                                <p style="color: var(--text-secondary);">${vehicle.color}</p>
                                ${vehicle.customDetails ? `<p style="color: var(--info); font-size: 13px; margin-top: 5px;">🎨 ${vehicle.customDetails.substring(0, 100)}...</p>` : ''}
                            </div>
                            <div class="vehicle-actions">
                                ${!vehicle.stolen ? `
                                    <button class="btn-small btn-report" onclick="showReportStolenModal('${vehicle.id}')">🚨 Report Stolen</button>
                                    <button class="btn-small btn-gps" onclick="toggleGPS('${vehicle.id}')">📍 GPS</button>
                                ` : ''}
                                <button class="btn-small btn-edit" onclick="editVehicle('${vehicle.id}')">✏️ Edit</button>
                                <button class="btn-small btn-delete" onclick="deleteVehicle('${vehicle.id}')">🗑️ Remove</button>
                            </div>
                        </div>
                        <div class="vehicle-details">
                            <div class="detail-item">
                                <span class="detail-label">License Plate</span>
                                <span>${vehicle.licensePlate}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">State</span>
                                <span>${vehicle.state || 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">VIN</span>
                                <span>${vehicle.vin || 'Not provided'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Plan</span>
                                <span style="color: var(--primary); font-weight: bold; text-transform: capitalize;">${vehicle.plan || 'Basic'}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateVehicleCount() {
            document.getElementById('vehicle-count').textContent = window.userVehicles ? window.userVehicles.length : 0;
        }

        function toggleGPS(vehicleId) {
            alert('GPS tracking for this vehicle is active. You\'ll receive real-time alerts if it moves unexpectedly.');
        }

        function editVehicle(vehicleId) {
            const vehicle = window.userVehicles.find(v => v.id === vehicleId);
            if (!vehicle) return;
            
            document.getElementById('edit-vehicle-id').value = vehicle.id;
            document.getElementById('edit-vin').value = vehicle.vin || '';
            document.getElementById('edit-plan').value = vehicle.plan || 'basic';
            document.getElementById('edit-plate').value = vehicle.licensePlate || '';
            
            document.getElementById('edit-vehicle-modal').classList.add('active');
        }

        async function deleteVehicle(vehicleId) {
            if (!confirm('Remove this vehicle and cancel subscription?')) return;
            // Your existing delete logic here
        }

        // Form submission
        document.getElementById('add-vehicle-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!window.currentUser) {
                alert('Please log in');
                return;
            }

            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="loading-spinner"></span> Processing...';

            try {
                const year = document.getElementById('add-year').value;
                const make = document.getElementById('add-make').value;
                let model = document.getElementById('add-model').value;
                const color = document.getElementById('add-color').value;
                const licensePlate = document.getElementById('add-plate').value.trim().toUpperCase();
                const state = document.getElementById('add-state').value;
                const vin = document.getElementById('add-vin').value.trim();
                const customDetails = document.getElementById('add-custom-details').value.trim();
                const plan = document.getElementById('add-plan').value;
                const imageFile = imageInput.files[0];

                if (!imageFile) {
                    alert('Please upload a vehicle photo');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Add Vehicle & Pay';
                    return;
                }

                if (model === 'Other/Custom') {
                    const customModel = document.getElementById('custom-model').value.trim();
                    if (!customModel) {
                        alert('Please enter a custom model name');
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Add Vehicle & Pay';
                        return;
                    }
                    model = customModel;
                }

                // Upload image to Firebase Storage
                const timestamp = Date.now();
                const fileName = `${window.currentUser.uid}_${timestamp}_${imageFile.name}`;
                const storageRef = window.firebaseStorageRef(window.firebaseStorage, `vehicles/${window.currentUser.uid}/${fileName}`);
                
                await window.firebaseUploadBytes(storageRef, imageFile);
                const imageUrl = await window.firebaseGetDownloadURL(storageRef);

                // Create vehicle data
                const vehicleData = {
                    year, make, model, color, licensePlate, state, vin, customDetails, plan,
                    imageUrl,
                    imagePath: `vehicles/${window.currentUser.uid}/${fileName}`,
                    userId: window.currentUser.uid,
                    userEmail: window.currentUser.email,
                    createdAt: Date.now()
                };

                // Save to Firebase Database
                const vehiclesRef = window.firebaseRef(window.firebaseDatabase, `vehicles/${window.currentUser.uid}`);
                const newVehicleRef = window.firebasePush(vehiclesRef);
                
                await window.firebaseSet(newVehicleRef, {
                    id: newVehicleRef.key,
                    ...vehicleData,
                    paymentStatus: 'pending',
                    stolen: false
                });

                // Create Stripe checkout
                const response = await fetch('http://localhost:3000/create-checkout-session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        vehicleId: newVehicleRef.key,
                        userId: window.currentUser.uid,
                        userEmail: window.currentUser.email,
                        plan,
                        vehicleData: `${year} ${make} ${model}`,
                        successUrl: `${window.location.origin}${window.location.pathname}?payment=success`,
                        cancelUrl: `${window.location.origin}${window.location.pathname}?payment=cancel`
                    })
                });

                if (!response.ok) throw new Error('Payment setup failed');

                const { sessionId } = await response.json();
                await stripe.redirectToCheckout({ sessionId });

            } catch (error) {
                console.error('Error:', error);
                alert('Error: ' + error.message);
                submitBtn.disabled = false;
                submitBtn.textContent = 'Add Vehicle & Pay';
            }
        });

        // Report stolen form
        document.getElementById('report-stolen-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const vehicleId = document.getElementById('stolen-vehicle-select').value;
            const reportNumber = document.getElementById('stolen-report-number').value;
            const department = document.getElementById('stolen-department').value;
            const officer = document.getElementById('stolen-officer').value;
            const datetime = document.getElementById('stolen-datetime').value;
            const location = document.getElementById('stolen-location').value;
            const circumstances = document.getElementById('stolen-circumstances').value;
            const witness = document.getElementById('stolen-witness').value;

            if (!vehicleId) {
                alert('Please select a vehicle');
                return;
            }

            try {
                // Mark vehicle as stolen in Firebase
                const vehicleRef = window.firebaseRef(window.firebaseDatabase, `vehicles/${window.currentUser.uid}/${vehicleId}`);
                await window.firebaseUpdate(vehicleRef, {
                    stolen: true,
                    stolenReport: {
                        reportNumber,
                        department,
                        officer,
                        datetime,
                        location,
                        circumstances,
                        witness,
                        reportedAt: Date.now()
                    }
                });

                // Add to stolen vehicles alerts
                const alertsRef = window.firebaseRef(window.firebaseDatabase, 'stolenVehicles');
                const vehicle = window.userVehicles.find(v => v.id === vehicleId);
                
                await window.firebasePush(alertsRef, {
                    ...vehicle,
                    stolenReport: {
                        reportNumber,
                        department,
                        officer,
                        datetime,
                        location,
                        circumstances
                    },
                    alertCreated: Date.now()
                });

                alert('Theft report submitted successfully! Community members will be alerted.');
                closeReportStolenModal();
                showSection('map-alerts');
            } catch (error) {
                console.error('Error submitting report:', error);
                alert('Error submitting report. Please try again.');
            }
        });

        // Found vehicle form
        document.getElementById('found-vehicle-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const plate = document.getElementById('found-plate').value;
            const location = document.getElementById('found-location').value;
            const report = document.getElementById('found-report').value;
            const department = document.getElementById('found-department').value;
            const zelle = document.getElementById('found-zelle').value;
            const witness = document.getElementById('found-witness').value;

            const reportId = 'FR' + Date.now().toString().slice(-8);

            alert(
                `✅ REPORT SUBMITTED SUCCESSFULLY!\n\n` +
                `🚗 License Plate: ${plate}\n` +
                `📍 Location: ${location}\n` +
                `📋 Police Report: ${report}\n` +
                `👮 Department: ${department}\n` +
                `👤 Witness: ${witness}\n` +
                `💰 Zelle Contact: ${zelle}\n\n` +
                `⏳ VERIFICATION PROCESS:\n\n` +
                `1️⃣ Our team will verify with ${department}\n` +
                `2️⃣ We'll confirm report #${report}\n` +
                `3️⃣ Match with vehicle owner's theft report\n` +
                `4️⃣ Process reward payment via Zelle\n\n` +
                `⏰ Verification typically takes 2-5 business days\n` +
                `💵 Reward amount: Based on vehicle's protection plan\n` +
                `   • Basic: $200\n` +
                `   • Gold: $300\n` +
                `   • Platinum: $500\n` +
                `   • Diamond: $750\n\n` +
                `📧 You'll receive email updates\n\n` +
                `🙏 Thank you for helping our community!\n\n` +
                `Your report ID: ${reportId}\n` +
                `Save this number for reference.`
            );

            e.target.reset();
        });

        // Stripe Checkout
        async function startCheckout(plan) {
            const priceIds = {
                basic: 'price_1QeTcRRxPKUgpxLKFsjv4iZC',
                gold: 'price_1QeTcnRxPKUgpxLKRvvfzC3Q',
                platinum: 'price_1QeTd4RxPKUgpxLKJKZyaG0O',
                diamond: 'price_1QeTdFRxPKUgpxLKU1oXUa9w'
            };

            try {
                const response = await fetch('http://localhost:3000/create-checkout-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        priceId: priceIds[plan],
                        userId: window.currentUser ? window.currentUser.uid : null,
                        userEmail: window.currentUser ? window.currentUser.email : null
                    })
                });

                const session = await response.json();
                
                const result = await stripe.redirectToCheckout({
                    sessionId: session.id
                });

                if (result.error) {
                    alert(result.error.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Unable to start checkout. Please try again.');
            }
        }

        // Carfax Connection
        function connectCarfax() {
            alert('🚧 Carfax integration coming soon! You\'ll be able to link your Carfax Car Care account for enhanced vehicle tracking.');
        }

        // Sign Out
        function signOut() {
            if (confirm('Are you sure you want to sign out?')) {
                if (window.firebaseSignOut && window.firebaseAuth) {
                    window.firebaseSignOut(window.firebaseAuth).then(() => {
                        localStorage.clear();
                        sessionStorage.clear();
                        window.location.href = 'cartrace_homepage.html';
                    }).catch((error) => {
                        console.error('Logout error:', error);
                        window.location.href = 'cartrace_homepage.html';
                    });
                } else {
                    window.location.href = 'cartrace_homepage.html';
                }
            }
        }

        // Live Stats Updates
        let networkUptime = 99.95;
        let responseTime = 0.8;
        let securityScore = 98;
        let dataPoints = 1234567;
        let activeUsers = 47892;

        function updateLiveStats() {
            const random = Math.random();
            
            if (random < 0.4) {
                networkUptime = Math.max(99.90, Math.min(99.99, networkUptime + (Math.random() - 0.5) * 0.02));
                responseTime = Math.max(0.5, Math.min(1.2, responseTime + (Math.random() - 0.5) * 0.1));
                securityScore = Math.max(90, Math.min(100, securityScore + Math.floor((Math.random() - 0.5) * 3)));
                dataPoints += Math.floor(Math.random() * 10);
                activeUsers = 47892 + Math.floor(Math.random() * 100);
            }
            
            document.getElementById('network-uptime').textContent = networkUptime.toFixed(2);
            document.getElementById('response-time').textContent = responseTime.toFixed(1);
            document.getElementById('security-score').textContent = securityScore;
            document.getElementById('data-points').textContent = dataPoints.toLocaleString();
            document.getElementById('active-users').textContent = activeUsers.toLocaleString();
        }
    </script>

    <!-- Firebase Module Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        import { getDatabase, ref, set, get, push, remove, update, onValue, off } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB8iFriCB3kt4lWeXQUNj5LTsAXFZoXX0Y",
            authDomain: "cartrace-pro.firebaseapp.com",
            databaseURL: "https://cartrace-pro-default-rtdb.firebaseio.com/",
            projectId: "cartrace-pro",
            storageBucket: "cartrace-pro.firebasestorage.app",
            messagingSenderId: "341907523496",
            appId: "1:341907523496:web:f10a87930d939cf3b8ff9d",
            measurementId: "G-X01QW112CD"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);
        const storage = getStorage(app);

        window.firebaseAuth = auth;
        window.firebaseDatabase = database;
        window.firebaseStorage = storage;
        window.firebaseRef = ref;
        window.firebaseSet = set;
        window.firebaseGet = get;
        window.firebasePush = push;
        window.firebaseRemove = remove;
        window.firebaseUpdate = update;
        window.firebaseOnValue = onValue;
        window.firebaseOff = off;
        window.firebaseSignOut = signOut;
        window.firebaseStorageRef = storageRef;
        window.firebaseUploadBytes = uploadBytes;
        window.firebaseGetDownloadURL = getDownloadURL;
        window.firebaseDeleteObject = deleteObject;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                window.currentUser = user;
                
                document.getElementById('user-email').textContent = user.email || 'User';
                document.getElementById('settings-email').value = user.email || 'user@example.com';
                document.getElementById('member-since').value = new Date(user.metadata.creationTime).toLocaleDateString();
                
                // Load vehicles with real-time updates
                const vehiclesRef = ref(database, `vehicles/${user.uid}`);
                onValue(vehiclesRef, (snapshot) => {
                    const data = snapshot.val();
                    
                    if (data) {
                        window.userVehicles = Object.keys(data).map(key => ({
                            ...data[key],
                            id: data[key].id || key
                        }));
                        localStorage.setItem('cartraceVehicles', JSON.stringify(window.userVehicles));
                    } else {
                        window.userVehicles = [];
                        localStorage.setItem('cartraceVehicles', JSON.stringify([]));
                    }
                    
                    updateVehicleDisplay();
                    updateVehicleCount();
                });

                // Listen for stolen vehicle alerts in real-time
                const alertsRef = ref(database, 'stolenVehicles');
                onValue(alertsRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        const alerts = Object.keys(data).map(key => ({
                            ...data[key],
                            id: key
                        }));
                        
                        // Update alert count
                        document.getElementById('alert-badge').textContent = alerts.length;
                        document.getElementById('active-alerts-count').textContent = alerts.length;
                        
                        stolenVehicles = alerts;
                    }
                });
            } else {
                window.location.href = 'cartrace_homepage.html';
            }
        });
    </script>
</body>
</html>

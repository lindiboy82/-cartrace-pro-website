<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CarTrace Pro - Dashboard</title>
    
    <!-- Stripe.js -->
    <script src="https://js.stripe.com/v3/"></script>
    
    <!-- Leaflet for Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --secondary: #2196F3;
            --danger: #ef4444;
            --warning: #f59e0b;
            --success: #10b981;
            --info: #3b82f6;
            --dark: #111827;
            --light: #f8fafc;
            --white: #FFFFFF;
            --surface: #f3f4f6;
            --card-bg: rgba(255, 255, 255, 0.95);
            --text-primary: #111827;
            --text-secondary: #6b7280;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text-primary);
        }

        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Navigation */
        .sidebar {
            width: 280px;
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        .logo-section {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
        }

        .app-logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 15px;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 400"><defs><radialGradient id="globeGrad" cx="50%" cy="40%" r="70%"><stop offset="0%" style="stop-color:%23a8c8ec"/><stop offset="100%" style="stop-color:%232563eb"/></radialGradient></defs><circle cx="200" cy="220" r="140" fill="url(%23globeGrad)"/><g stroke="white" stroke-width="3" fill="none"><circle cx="200" cy="220" r="140"/><ellipse cx="200" cy="220" rx="140" ry="70"/><ellipse cx="200" cy="220" rx="70" ry="140"/><line x1="60" y1="220" x2="340" y2="220"/><line x1="200" y1="80" x2="200" y2="360"/></g><path d="M200 80 L230 160 L200 200 Z" fill="%23dc2626"/><ellipse cx="210" cy="130" rx="18" ry="18" fill="white"/><text x="200" y="35" text-anchor="middle" fill="%23111827" font-family="Arial Black" font-size="40" font-weight="bold">Car Trace</text></svg>') center/contain no-repeat;
        }

        .app-title {
            font-size: 20px;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .app-subtitle {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 8px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            color: var(--text-primary);
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s;
            font-weight: 500;
            cursor: pointer;
        }

        .nav-link:hover, .nav-link.active {
            background: var(--primary);
            color: white;
            transform: translateX(4px);
        }

        .nav-icon {
            margin-right: 12px;
            font-size: 18px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .header {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            padding: 20px 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 28px;
            font-weight: bold;
            color: var(--primary);
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .card-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .card-icon {
            margin-right: 10px;
            font-size: 24px;
        }

        /* Vehicle List */
        .vehicle-list {
            display: grid;
            gap: 20px;
        }

        .vehicle-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            border-left: 4px solid var(--primary);
            display: flex;
            gap: 20px;
        }

        .vehicle-image {
            width: 150px;
            height: 150px;
            border-radius: 8px;
            object-fit: cover;
            flex-shrink: 0;
        }

        .vehicle-content {
            flex: 1;
        }

        .vehicle-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .vehicle-info h3 {
            color: var(--primary);
            margin-bottom: 5px;
        }

        .vehicle-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 13px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-edit {
            background: var(--info);
            color: white;
        }

        .btn-delete {
            background: var(--danger);
            color: white;
        }

        .vehicle-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 50px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
        }

        .close-modal {
            font-size: 28px;
            cursor: pointer;
            color: var(--text-secondary);
            background: none;
            border: none;
        }

        .close-modal:hover {
            color: var(--danger);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-select {
            background: white;
            cursor: pointer;
        }

        .form-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            font-size: 16px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-primary:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        /* Image Upload */
        .image-upload-area {
            border: 2px dashed #e5e7eb;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .image-upload-area:hover {
            border-color: var(--primary);
            background: #f9fafb;
        }

        .image-upload-area.dragging {
            border-color: var(--primary);
            background: #eff6ff;
        }

        .image-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }

        .image-preview.show {
            display: block;
        }

        .upload-icon {
            font-size: 48px;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .form-helper {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
            }
            .nav-link span {
                display: none;
            }
            .vehicle-card {
                flex-direction: column;
            }
            .vehicle-image {
                width: 100%;
                height: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo-section">
                <div class="app-logo"></div>
                <div class="app-title">CarTrace Pro</div>
                <div class="app-subtitle">Vehicle Protection Network</div>
            </div>
            
            <ul class="nav-menu">
                <li class="nav-item">
                    <a class="nav-link active" onclick="showSection('dashboard')">
                        <span class="nav-icon">🏠</span>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showSection('vehicles')">
                        <span class="nav-icon">🚗</span>
                        <span>My Vehicles</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showSection('settings')">
                        <span class="nav-icon">⚙️</span>
                        <span>Settings</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="signOut()">
                        <span class="nav-icon">🚪</span>
                        <span>Sign Out</span>
                    </a>
                </li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Section -->
            <div class="content-section active" id="dashboard-section">
                <div class="header">
                    <div>
                        <h1 class="header-title">Welcome Back!</h1>
                        <p id="user-email">Loading...</p>
                    </div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-title">
                            <span class="card-icon">🚗</span>
                            Protected Vehicles
                        </div>
                        <div style="font-size: 36px; font-weight: bold; color: var(--primary); margin: 15px 0;">
                            <span id="vehicle-count">0</span>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title">
                            <span class="card-icon">🌐</span>
                            Network Status
                        </div>
                        <div style="font-size: 36px; font-weight: bold; color: var(--success); margin: 15px 0;">
                            47,892
                        </div>
                    </div>
                </div>
            </div>

            <!-- My Vehicles Section -->
            <div class="content-section" id="vehicles-section">
                <div class="header">
                    <h1 class="header-title">My Vehicles</h1>
                    <button class="btn btn-primary" onclick="showAddVehicleModal()" style="width: auto;">
                        + Add Vehicle
                    </button>
                </div>

                <div class="vehicle-list" id="vehicle-list">
                    <p style="text-align: center; color: var(--text-secondary); padding: 40px;">
                        No vehicles added yet. Click "Add Vehicle" to get started!
                    </p>
                </div>
            </div>

            <!-- Settings Section -->
            <div class="content-section" id="settings-section">
                <div class="header">
                    <h1 class="header-title">Account Settings</h1>
                </div>
                <div class="card">
                    <div class="card-title">
                        <span class="card-icon">👤</span>
                        Profile Information
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        <input type="email" class="form-input" id="settings-email" readonly>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Vehicle Modal with Dropdowns and Image Upload -->
    <div class="modal" id="add-vehicle-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add New Vehicle</h2>
                <button class="close-modal" onclick="closeAddVehicleModal()">&times;</button>
            </div>

            <form id="add-vehicle-form">
                <!-- Image Upload -->
                <div class="form-group">
                    <label class="form-label">Vehicle Photo *</label>
                    <div class="image-upload-area" id="image-upload-area" onclick="document.getElementById('vehicle-image').click()">
                        <div class="upload-icon">📸</div>
                        <div style="color: var(--text-secondary); font-size: 14px;">
                            <strong style="color: var(--primary);">Click to upload</strong> or drag and drop<br>
                            <small>PNG, JPG, JPEG up to 5MB</small>
                        </div>
                    </div>
                    <input type="file" id="vehicle-image" accept="image/*" style="display: none;" required>
                    <img id="image-preview" class="image-preview" alt="Vehicle preview">
                </div>

                <!-- Year Dropdown -->
                <div class="form-group">
                    <label class="form-label">Year *</label>
                    <select class="form-select" id="add-year" required>
                        <option value="">Select Year</option>
                    </select>
                </div>

                <!-- Make Dropdown -->
                <div class="form-group">
                    <label class="form-label">Make *</label>
                    <select class="form-select" id="add-make" required onchange="updateModels()">
                        <option value="">Select Make</option>
                    </select>
                </div>

                <!-- Model Dropdown -->
                <div class="form-group">
                    <label class="form-label">Model *</label>
                    <select class="form-select" id="add-model" required>
                        <option value="">Select Make First</option>
                    </select>
                    <div class="form-helper">Select "Other/Custom" for special or custom vehicles</div>
                </div>

                <!-- Custom Model Input (shows when Other/Custom selected) -->
                <div class="form-group" id="custom-model-group" style="display: none;">
                    <label class="form-label">Custom Model Name *</label>
                    <input type="text" class="form-input" id="custom-model" placeholder="e.g., GT-R Nismo, Custom Build">
                </div>

                <!-- Color Dropdown -->
                <div class="form-group">
                    <label class="form-label">Color *</label>
                    <select class="form-select" id="add-color" required>
                        <option value="">Select Color</option>
                        <optgroup label="Common Colors">
                            <option value="Black">Black</option>
                            <option value="White">White</option>
                            <option value="Silver">Silver</option>
                            <option value="Gray">Gray</option>
                            <option value="Red">Red</option>
                            <option value="Blue">Blue</option>
                            <option value="Green">Green</option>
                            <option value="Yellow">Yellow</option>
                            <option value="Orange">Orange</option>
                            <option value="Brown">Brown</option>
                            <option value="Beige">Beige</option>
                            <option value="Gold">Gold</option>
                        </optgroup>
                        <optgroup label="Metallic Colors">
                            <option value="Metallic Black">Metallic Black</option>
                            <option value="Metallic Silver">Metallic Silver</option>
                            <option value="Metallic Gray">Metallic Gray</option>
                            <option value="Metallic Blue">Metallic Blue</option>
                            <option value="Metallic Red">Metallic Red</option>
                            <option value="Metallic Green">Metallic Green</option>
                            <option value="Metallic Bronze">Metallic Bronze</option>
                            <option value="Metallic Gold">Metallic Gold</option>
                        </optgroup>
                        <optgroup label="Premium Colors">
                            <option value="Pearl White">Pearl White</option>
                            <option value="Midnight Blue">Midnight Blue</option>
                            <option value="Deep Sea Blue">Deep Sea Blue</option>
                            <option value="Racing Red">Racing Red</option>
                            <option value="Candy Apple Red">Candy Apple Red</option>
                            <option value="British Racing Green">British Racing Green</option>
                            <option value="Champagne">Champagne</option>
                            <option value="Burgundy">Burgundy</option>
                            <option value="Navy Blue">Navy Blue</option>
                            <option value="Forest Green">Forest Green</option>
                        </optgroup>
                        <optgroup label="Matte/Special Finishes">
                            <option value="Matte Black">Matte Black</option>
                            <option value="Matte Gray">Matte Gray</option>
                            <option value="Matte White">Matte White</option>
                            <option value="Matte Blue">Matte Blue</option>
                            <option value="Matte Red">Matte Red</option>
                            <option value="Satin Black">Satin Black</option>
                            <option value="Chrome">Chrome</option>
                            <option value="Rose Gold">Rose Gold</option>
                        </optgroup>
                        <optgroup label="Other">
                            <option value="Two-Tone">Two-Tone</option>
                            <option value="Custom Wrap">Custom Wrap</option>
                            <option value="Custom Paint">Custom Paint</option>
                            <option value="Other">Other</option>
                        </optgroup>
                    </select>
                </div>

                <!-- License Plate -->
                <div class="form-group">
                    <label class="form-label">License Plate *</label>
                    <input type="text" class="form-input" id="add-plate" required placeholder="ABC123" style="text-transform: uppercase;">
                </div>

                <!-- VIN -->
                <div class="form-group">
                    <label class="form-label">VIN (Optional)</label>
                    <input type="text" class="form-input" id="add-vin" maxlength="17" placeholder="17-digit VIN number">
                </div>

                <!-- Custom Details -->
                <div class="form-group">
                    <label class="form-label">Custom Details (Optional)</label>
                    <textarea class="form-textarea" id="add-custom-details" placeholder="Add custom details like:
• Custom wheels (Forgiato, BBS, HRE, etc.)
• Body modifications (carbon fiber wing, widebody kit, etc.)
• Performance upgrades (turbo, supercharger, exhaust, etc.)
• Paint/Wrap details
• Interior modifications"></textarea>
                </div>

                <!-- Protection Plan -->
                <div class="form-group">
                    <label class="form-label">Protection Plan *</label>
                    <select class="form-select" id="add-plan" required>
                        <option value="basic">Basic - $17.99/mo</option>
                        <option value="gold">Gold - $24.99/mo</option>
                        <option value="platinum">Platinum - $29.99/mo</option>
                        <option value="diamond">Diamond - $35.00/mo</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-primary" id="submit-btn">
                    Add Vehicle & Pay
                </button>
            </form>
        </div>
    </div>

    <script>
        // Vehicle Database - Makes and Models (1990-2026)
        const vehicleDatabase = {
            'Acura': ['CL', 'CSX', 'ILX', 'Integra', 'Legend', 'MDX', 'NSX', 'RDX', 'RL', 'RLX', 'RSX', 'TL', 'TLX', 'TSX', 'ZDX', 'Other/Custom'],
            'Audi': ['A3', 'A4', 'A5', 'A6', 'A7', 'A8', 'Q3', 'Q4 e-tron', 'Q5', 'Q7', 'Q8', 'R8', 'RS3', 'RS4', 'RS5', 'RS6', 'RS7', 'S3', 'S4', 'S5', 'S6', 'TT', 'e-tron', 'Other/Custom'],
            'BMW': ['1 Series', '2 Series', '3 Series', '4 Series', '5 Series', '6 Series', '7 Series', '8 Series', 'M2', 'M3', 'M4', 'M5', 'M8', 'X1', 'X2', 'X3', 'X4', 'X5', 'X6', 'X7', 'Z4', 'i3', 'i4', 'i8', 'iX', 'Other/Custom'],
            'Chevrolet': ['Blazer', 'Bolt', 'Camaro', 'Colorado', 'Corvette', 'Cruze', 'Equinox', 'Impala', 'Malibu', 'Silverado', 'Spark', 'Suburban', 'Tahoe', 'Traverse', 'Trax', 'Volt', 'Other/Custom'],
            'Dodge': ['Challenger', 'Charger', 'Dart', 'Durango', 'Grand Caravan', 'Journey', 'Ram', 'Viper', 'Other/Custom'],
            'Ferrari': ['296 GTB', '458', '488', '812', 'California', 'F8', 'LaFerrari', 'Portofino', 'Roma', 'SF90', 'Other/Custom'],
            'Ford': ['Bronco', 'Edge', 'Escape', 'Expedition', 'Explorer', 'F-150', 'F-250', 'Fiesta', 'Focus', 'Fusion', 'Maverick', 'Mustang', 'Ranger', 'Taurus', 'Other/Custom'],
            'Honda': ['Accord', 'CR-V', 'Civic', 'Clarity', 'Fit', 'HR-V', 'Insight', 'Odyssey', 'Passport', 'Pilot', 'Ridgeline', 'Other/Custom'],
            'Hyundai': ['Accent', 'Elantra', 'Ioniq', 'Kona', 'Palisade', 'Santa Cruz', 'Santa Fe', 'Sonata', 'Tucson', 'Veloster', 'Venue', 'Other/Custom'],
            'Jeep': ['Cherokee', 'Compass', 'Gladiator', 'Grand Cherokee', 'Renegade', 'Wrangler', 'Other/Custom'],
            'Lamborghini': ['Aventador', 'Huracan', 'Revuelto', 'Urus', 'Other/Custom'],
            'Lexus': ['CT', 'ES', 'GS', 'GX', 'IS', 'LC', 'LS', 'LX', 'NX', 'RC', 'RX', 'UX', 'Other/Custom'],
            'Mercedes-Benz': ['A-Class', 'AMG GT', 'C-Class', 'CLA', 'CLS', 'E-Class', 'EQC', 'EQS', 'G-Class', 'GLA', 'GLB', 'GLC', 'GLE', 'GLS', 'S-Class', 'SL', 'Other/Custom'],
            'Nissan': ['Altima', 'Armada', 'Frontier', 'GT-R', 'Kicks', 'Leaf', 'Maxima', 'Murano', 'Pathfinder', 'Rogue', 'Sentra', 'Titan', 'Versa', 'Z', 'Other/Custom'],
            'Porsche': ['911', 'Boxster', 'Cayenne', 'Cayman', 'Macan', 'Panamera', 'Taycan', 'Other/Custom'],
            'Tesla': ['Cybertruck', 'Model 3', 'Model S', 'Model X', 'Model Y', 'Roadster', 'Other/Custom'],
            'Toyota': ['4Runner', '86', 'Avalon', 'Camry', 'Corolla', 'GR Supra', 'Highlander', 'Land Cruiser', 'Prius', 'RAV4', 'Sequoia', 'Sienna', 'Tacoma', 'Tundra', 'Venza', 'Yaris', 'Other/Custom'],
            'Volkswagen': ['Arteon', 'Atlas', 'Golf', 'GTI', 'ID.4', 'Jetta', 'Passat', 'Taos', 'Tiguan', 'Other/Custom'],
            'Other/Custom': ['Custom Build', 'Kit Car', 'Modified Vehicle', 'Specialty Vehicle', 'Classic/Vintage', 'Exotic/Rare', 'Other']
        };

        // Populate year dropdown (1990-2026)
        function populateYears() {
            const yearSelect = document.getElementById('add-year');
            for (let year = 2026; year >= 1990; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }
        }

        // Populate makes dropdown
        function populateMakes() {
            const makeSelect = document.getElementById('add-make');
            const makes = Object.keys(vehicleDatabase).sort();
            makes.forEach(make => {
                const option = document.createElement('option');
                option.value = make;
                option.textContent = make;
                makeSelect.appendChild(option);
            });
        }

        // Update models based on selected make
        function updateModels() {
            const make = document.getElementById('add-make').value;
            const modelSelect = document.getElementById('add-model');
            const customModelGroup = document.getElementById('custom-model-group');
            
            modelSelect.innerHTML = '<option value="">Select Model</option>';
            
            if (make && vehicleDatabase[make]) {
                vehicleDatabase[make].forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = model;
                    modelSelect.appendChild(option);
                });
            }

            modelSelect.onchange = function() {
                if (this.value === 'Other/Custom') {
                    customModelGroup.style.display = 'block';
                    document.getElementById('custom-model').required = true;
                } else {
                    customModelGroup.style.display = 'none';
                    document.getElementById('custom-model').required = false;
                }
            };
        }

        // Image upload handling
        const imageInput = document.getElementById('vehicle-image');
        const imagePreview = document.getElementById('image-preview');
        const imageUploadArea = document.getElementById('image-upload-area');

        imageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) {
                    alert('Image size must be less than 5MB');
                    this.value = '';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.src = e.target.result;
                    imagePreview.classList.add('show');
                };
                reader.readAsDataURL(file);
            }
        });

        // Drag and drop
        imageUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            imageUploadArea.classList.add('dragging');
        });

        imageUploadArea.addEventListener('dragleave', () => {
            imageUploadArea.classList.remove('dragging');
        });

        imageUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            imageUploadArea.classList.remove('dragging');
            
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                imageInput.files = e.dataTransfer.files;
                imageInput.dispatchEvent(new Event('change'));
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            populateYears();
            populateMakes();
        });

        // Navigation
        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.getElementById(sectionId + '-section').classList.add('active');
            event.target.closest('.nav-link').classList.add('active');
        }

        // Modal functions
        function showAddVehicleModal() {
            document.getElementById('add-vehicle-modal').classList.add('active');
        }

        function closeAddVehicleModal() {
            document.getElementById('add-vehicle-modal').classList.remove('active');
            document.getElementById('add-vehicle-form').reset();
            document.getElementById('custom-model-group').style.display = 'none';
            imagePreview.classList.remove('show');
        }

        function updateVehicleDisplay() {
            const vehicleList = document.getElementById('vehicle-list');
            
            if (!window.userVehicles || window.userVehicles.length === 0) {
                vehicleList.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 40px;">No vehicles added yet.</p>';
                return;
            }

            vehicleList.innerHTML = window.userVehicles.map(vehicle => `
                <div class="vehicle-card">
                    ${vehicle.imageUrl ? `<img src="${vehicle.imageUrl}" class="vehicle-image" alt="${vehicle.year} ${vehicle.make} ${vehicle.model}">` : ''}
                    <div class="vehicle-content">
                        <div class="vehicle-header">
                            <div class="vehicle-info">
                                <h3>${vehicle.year} ${vehicle.make} ${vehicle.model}</h3>
                                <p style="color: var(--text-secondary);">${vehicle.color}</p>
                                ${vehicle.customDetails ? `<p style="color: var(--info); font-size: 13px; margin-top: 5px;">🎨 ${vehicle.customDetails.substring(0, 100)}...</p>` : ''}
                            </div>
                            <div class="vehicle-actions">
                                <button class="btn-small btn-delete" onclick="deleteVehicle('${vehicle.id}')">🗑️ Remove</button>
                            </div>
                        </div>
                        <div class="vehicle-details">
                            <div class="detail-item">
                                <span class="detail-label">License Plate</span>
                                <span>${vehicle.licensePlate}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">VIN</span>
                                <span>${vehicle.vin || 'Not provided'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Plan</span>
                                <span style="color: var(--primary); font-weight: bold; text-transform: capitalize;">${vehicle.plan || 'Basic'}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateVehicleCount() {
            document.getElementById('vehicle-count').textContent = window.userVehicles ? window.userVehicles.length : 0;
        }

        async function deleteVehicle(vehicleId) {
            if (!confirm('Remove this vehicle and cancel subscription?')) return;
            
            // Your existing delete logic here
            // Should call your backend to cancel Stripe subscription
        }

        // Form submission - connects to YOUR existing backend
        document.getElementById('add-vehicle-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!window.currentUser) {
                alert('Please log in');
                return;
            }

            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="loading-spinner"></span> Processing...';

            try {
                const year = document.getElementById('add-year').value;
                const make = document.getElementById('add-make').value;
                let model = document.getElementById('add-model').value;
                const color = document.getElementById('add-color').value;
                const licensePlate = document.getElementById('add-plate').value.trim().toUpperCase();
                const vin = document.getElementById('add-vin').value.trim();
                const customDetails = document.getElementById('add-custom-details').value.trim();
                const plan = document.getElementById('add-plan').value;
                const imageFile = imageInput.files[0];

                if (!imageFile) {
                    alert('Please upload a vehicle photo');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Add Vehicle & Pay';
                    return;
                }

                // Use custom model if selected
                if (model === 'Other/Custom') {
                    const customModel = document.getElementById('custom-model').value.trim();
                    if (!customModel) {
                        alert('Please enter a custom model name');
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Add Vehicle & Pay';
                        return;
                    }
                    model = customModel;
                }

                // 1. Upload image to Firebase Storage
                const timestamp = Date.now();
                const fileName = `${window.currentUser.uid}_${timestamp}_${imageFile.name}`;
                const storageRef = window.firebaseStorageRef(window.firebaseStorage, `vehicles/${window.currentUser.uid}/${fileName}`);
                
                await window.firebaseUploadBytes(storageRef, imageFile);
                const imageUrl = await window.firebaseGetDownloadURL(storageRef);

                // 2. Create vehicle data
                const vehicleData = {
                    year, make, model, color, licensePlate, vin, customDetails, plan,
                    imageUrl: imageUrl,
                    imagePath: `vehicles/${window.currentUser.uid}/${fileName}`,
                    userId: window.currentUser.uid,
                    userEmail: window.currentUser.email,
                    createdAt: Date.now()
                };

                // 3. Save to Firebase Database FIRST
                const vehiclesRef = window.firebaseRef(window.firebaseDatabase, `vehicles/${window.currentUser.uid}`);
                const newVehicleRef = window.firebasePush(vehiclesRef);
                
                await window.firebaseSet(newVehicleRef, {
                    id: newVehicleRef.key,
                    ...vehicleData,
                    paymentStatus: 'pending',
                    stolen: false
                });

                // 4. Call YOUR backend to create Stripe checkout
                const response = await fetch('http://localhost:3000/create-checkout-session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        vehicleId: newVehicleRef.key,
                        userId: window.currentUser.uid,
                        userEmail: window.currentUser.email,
                        plan: plan,
                        vehicleData: `${year} ${make} ${model}`,
                        successUrl: `${window.location.origin}${window.location.pathname}?payment=success`,
                        cancelUrl: `${window.location.origin}${window.location.pathname}?payment=cancel`
                    })
                });

                if (!response.ok) throw new Error('Payment setup failed');

                const { sessionId } = await response.json();
                
                // 5. Redirect to Stripe Checkout
                const stripe = Stripe('pk_test_51QeTZeRxPKUgpxLKOOPLpxDGJoCF3u7QmGqBjsVqRJZuEcAzQ1JW4iqh6XxGIONhL9o7JnqkdPcXzFYt8bPbvC6x009cz5i5rT');
                await stripe.redirectToCheckout({ sessionId });

            } catch (error) {
                console.error('Error:', error);
                alert('Error: ' + error.message);
                submitBtn.disabled = false;
                submitBtn.textContent = 'Add Vehicle & Pay';
            }
        });

        function signOut() {
            if (confirm('Sign out?')) {
                if (window.firebaseSignOut && window.firebaseAuth) {
                    window.firebaseSignOut(window.firebaseAuth).then(() => {
                        window.location.href = 'index.html';
                    });
                }
            }
        }
    </script>

    <!-- Firebase Integration -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        import { getDatabase, ref, set, get, push, remove, update, onValue } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB8iFriCB3kt4lWeXQUNj5LTsAXFZoXX0Y",
            authDomain: "cartrace-pro.firebaseapp.com",
            databaseURL: "https://cartrace-pro-default-rtdb.firebaseio.com/",
            projectId: "cartrace-pro",
            storageBucket: "cartrace-pro.firebasestorage.app",
            messagingSenderId: "341907523496",
            appId: "1:341907523496:web:f10a87930d939cf3b8ff9d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);
        const storage = getStorage(app);

        window.firebaseAuth = auth;
        window.firebaseDatabase = database;
        window.firebaseStorage = storage;
        window.firebaseRef = ref;
        window.firebaseSet = set;
        window.firebaseGet = get;
        window.firebasePush = push;
        window.firebaseRemove = remove;
        window.firebaseUpdate = update;
        window.firebaseOnValue = onValue;
        window.firebaseSignOut = signOut;
        window.firebaseStorageRef = storageRef;
        window.firebaseUploadBytes = uploadBytes;
        window.firebaseGetDownloadURL = getDownloadURL;
        window.firebaseDeleteObject = deleteObject;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                window.currentUser = user;
                document.getElementById('user-email').textContent = user.email;
                document.getElementById('settings-email').value = user.email;
                
                const vehiclesRef = ref(database, `vehicles/${user.uid}`);
                onValue(vehiclesRef, (snapshot) => {
                    const data = snapshot.val();
                    window.userVehicles = data ? Object.values(data) : [];
                    updateVehicleDisplay();
                    updateVehicleCount();
                });
            } else {
                window.location.href = 'index.html';
            }
        });
    </script>
</body>
</html>
